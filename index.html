<!DOCTYPE html>
<html lang='ru'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'>
<style>
body {
	margin: 0;
	font-family: sans-serif;
	background: white;
	color: black;
}
#options .opener {
	position: fixed;
	top: 0;
	left: 0;
	/*
	width: 10em;
	height: 2em;
	*/
	background: white;
}
#options .dialog {
	display: none;
	position: fixed;
	overflow: auto;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: white;
}
#options .dialog.open {
	display: block;
}
#options .block {
	max-width: 30em;
	margin: 2em auto;
}
.conjtable table {
	border-collapse: collapse;
}
.conjtable tbody {
	border-top: solid 1px gray;
}
.conjtable td,
.conjtable th {
	text-align: left;
	font-weight: normal;
}
.conjtable th {
	padding: .2rem;
}
.conjtable td {
	padding: 0 .2rem;
	white-space: nowrap;
}
.conjtable thead th {
	position: sticky;
	top: 0;
	background: white;
}
.conjtable tbody th {
	position: sticky;
	background: white;
	left: 1.4rem;
}
.conjtable tbody th.group {
	left: 0;
}
.conjtable tbody th[colspan] {
	left: 0;
}
.conjtable tr.number-s td span,
.conjtable tr.number-s th {
	padding-bottom: 0;
}
.conjtable tr.number-p:not(:first-child) td span,
.conjtable tr.number-p:not(:first-child) th {
	padding-top: 0;
}
.conjtable th.group {
	width: 1rem;
}
.conjtable th.group span {
	width: 1rem;
	writing-mode: vertical-rl;
	transform: rotate(180deg);
}
.conjtable td[title],
.conjtable th[title] {
	background: linear-gradient(135deg, #484 .3rem, transparent .3rem), white;
}
.conjtable th.long {
	letter-spacing: -0.07rem;
}
.conjtable th.very-long {
	letter-spacing: -0.07rem;
	font-size: 0.8rem;
}
.conjtable .stem {
	display: inline-block;
	border-right: solid 1px #060;
	padding: .2rem .05rem .2rem 0;
}
.conjtable .stem + .end {
	border: none;
}
.conjtable .end {
	display: inline-block;
	font-weight: bold;
	border-left: solid 1px #060;
	padding: .2rem 0 .2rem .05rem;
}
.conjtable .subend {
	display: inline-block;
	color: #333;
	font-weight: bold;
	border-left: solid 1px #DDD;
	padding: .2rem 0 .2rem .05rem;
}
.conjtable strong {
	font-weight: normal;
	color: #608;
}
.conjtable strong.insert {
	color: #A00;
}
.conjtable .end strong {
	font-weight: bold;
}
.conjtable .stem strong:empty,
.conjtable .end strong:empty {
	display: inline-block;
	width: .5ex;
	border-bottom: solid 1px #A00;
}
.conjtable th em,
.conjtable .end em,
.conjtable .subend em {
	font-style: normal;
	color: green;
}
.conjtable .combination em {
	animation: 1s 2 alternate blink;
}
@keyframes blink {
	from {
		opacity: 1;
	}
	to {
		opacity: 0.1;
	}
}
</style>
</head>
<body>
<script>
const verbForms={
	nonpers: ['','безличные формы'], // don't display group title
	inf: ['Infinitivo','инфинитив'],
	ger: ['Gerundio','для образования аналога continuous в английском по схеме спряжённый-estar + Ger. ("estoy estudiando" = "I am studying")'],
	par: ['Participio','страдательное(?) причастие прошедшего времени, меняется по родам и числам (apagado = выключенный, apagada = выключенная)'],
	pres: ['Presente','Presente'],
	pret: ['Pretérito','Pretérito indefinido'],
	imp: ['Imperfecto','Pretérito imperfecto'],
	fut: ['Futuro','Futuro'],
	cond: ['Condicional','Condicional'],
	subj: ['Subjuntivo','Presente de subjuntivo'],
	im: ['Imperativo','Imperativo'],
	im2s: ['tú','tú: ты сделай; форма глагола обычно совпадает с 3-м лицом ед. ч. Presente'],
	im3s: ['usted','usted: (вежливое) вы сделайте; форма глагола обычно совпадает императивом для tú, только окончание a меняется на e и наоборот'],
	im1p: ['nosotros','nosotros, nosotras: давайте мы сделаем'],
	im2p: ['vosotros','vosotros, vosotras: (множественное) вы сделайте'],
	im3p: ['ustedes','ustedes: (вежливое множественное) вы сделайте'],
}
for (const [prefix,v0,[v1s,v2s,v3sm,v3sf,v1p,v2p,v3p]] of [
	['pres','',        ['делаю','делаешь','делает','делает','делаем','делаете','делают']],
	['pret','',        ['сделал(а)','сделал(а)','сделал','сделала','сделали','сделали','сделали']],
	['fut' ,'',        ['сделаю','сделаешь','сделает','сделает','сделаем','сделаете','сделают']],
	['cond','',        ['бы сделал(а)','бы сделал(а)','бы сделал','бы сделала','бы сделали','бы сделали','бы сделали']],
	['subj','(чтобы) ',['сделал(а)','сделал(а)','сделал','сделала','сделали','сделали','сделали']],
	['imp' ,'',        ['делал(а)','делал(а)','делал','делала','делали','делали','делали']],
]) {
	verbForms[prefix+'1s']=['yo',`yo: ${v0}я ${v1s}`]
	verbForms[prefix+'2s']=['tú',`tú: ${v0}ты ${v2s}`]
	verbForms[prefix+'3s']=['él',`él: ${v0}он ${v3sm}; ella: она ${v3sf}; usted: (вежливое) ${v0}вы ${v2p}`]
	verbForms[prefix+'1p']=['nosotros',`nosotros, nosotras: ${v0}мы ${v1p}`]
	verbForms[prefix+'2p']=['vosotros',`vosotros, vosotras: (множественное) ${v0}вы ${v2p}`]
	verbForms[prefix+'3p']=['ellos',`ellos, ellas: ${v0}они ${v3p}; ustedes: (вежливое множественное) ${v0}вы ${v2p}`]
}
const compactableVerbForms={
	pres3: ['él<em>los</em>',verbForms.pres3s[1]+'; '+verbForms.pres3p[1]],
	pret2: ['tú/<em>vosotros</em>',verbForms.pret2s[1]+'; '+verbForms.pret2p[1]],
	imp2: ['tú/<em>vosotros</em>',verbForms.imp2s[1]+'; '+verbForms.imp2p[1]],
	imp3: ['él<em>los</em>',verbForms.imp3s[1]+'; '+verbForms.imp3p[1]],
	fut3: ['él<em>los</em>',verbForms.fut3s[1]+'; '+verbForms.fut3p[1]],
	cond1: ['yo/<em>nosotros</em>',verbForms.cond1s[1]+'; '+verbForms.cond1p[1]],
	cond2: ['tú/<em>vosotros</em>',verbForms.cond2s[1]+'; '+verbForms.cond2p[1]],
	cond3: ['él<em>los</em>',verbForms.cond3s[1]+'; '+verbForms.cond3p[1]],
	subj3: ['él<em>los</em>',verbForms.subj3s[1]+'; '+verbForms.subj3p[1]],
	im3: ['usted<em>es</em>','usted, ustedes: (вежливое) вы сделайте'],
}
const personalVerbForms=['pres','pret','imp','fut','cond','subj','im']
// wiktionary templates:
// https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Plantillas_de_flexi%C3%B3n_de_verbos
// https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Plantillas_auxiliares_de_flexi%C3%B3n
const v2=(inf)=>{
	const [stem,infEnd]=inf.split(/(..)$/)
	const formIds=(
		'inf,ger,par,'+
		'pres1s,pres2s,pres3s,pres1p,pres2p,pres3p,'+
		'pret1s,pret2s,pret3s,pret1p,pret2p,pret3p,'+
		'imp1s,imp2s,imp3s,imp1p,imp2p,imp3p,'+
		'fut1s,fut2s,fut3s,fut1p,fut2p,fut3p,'+
		'im2s,im3s,im1p,im2p,im3p'
	).split(',')
	const formEndsFut=(e)=>`${e}|é,${e}|ás,${e}|á,${e}|emos,${e}|éis,${e}|án,`
	const formEndsPretEir='í,iste,ió,imos,isteis,ieron,'
	const formEndsImpEir='í|a,í|as,í|a,í|amos,í|ais,í|an,'
	const formEnds={
	ar:(
		'ar,ando,ado,'+
		'o,as,a,amos,áis,an,'+
		'é,aste,ó,amos,asteis,aron,'+
		'ab|a,ab|as,ab|a,áb|amos,ab|ais,ab|an,'+
		formEndsFut('ar')+
		'a,e,emos,ad,en'
	).split(','),
	er:(
		'er,iendo,ido,'+
		'o,es,e,emos,éis,en,'+
		formEndsPretEir+
		formEndsImpEir+
		formEndsFut('er')+
		'e,a,amos,ed,an'
	).split(','),
	ir:(
		'ir,iendo,ido,'+
		'o,es,e,imos,ís,en,'+
		formEndsPretEir+
		formEndsImpEir+
		formEndsFut('ir')+
		'e,a,amos,id,an'
	).split(','),
	}
	const a=formEnds[infEnd]
	return formIds.reduce((o,k,i)=>({...o,[k]:stem+'|'+a[i]}),{})
}
const v2formIds=(pattern)=>{
	const [base,person,number]=pattern.split(/(.)(.)$/)
	function* subEnd(person,number) {
		yield base+person+number
	}
	function* subPerson(number) {
		if (person=='*') {
			for (let p of '123') yield* subEnd(p,number)
		} else {
			yield* subEnd(person,number)
		}
	}
	function* subNumber() {
		if (number=='*') {
			for (let n of 'sp') yield* subPerson(n)
		} else {
			yield* subPerson(number)
		}
	}
	return Array.from(subNumber())
}
const v2repl=(pattern,replacement)=>{
	const a=replacement.split(',')
	return v2formIds(pattern).reduce((o,k,i)=>({...o,[k]:a[i]}),{})
}
const v2replaceLastStemVowel=(form,oldVowel,newVowel)=>{
	if (oldVowel==newVowel) return form
	let replacement='['+newVowel+']'
	if (oldVowel.length!=newVowel.length) replacement='{'+newVowel+'}'
	const [oldStem,end]=form.split(/\|(.*)/)
	const i=oldStem.lastIndexOf(oldVowel)
	const newStem=oldStem.slice(0,i)+replacement+oldStem.slice(i+oldVowel.length)
	return newStem+'|'+end
}
const v2vowel=(v,V,dict)=>{ // https://es.wiktionary.org/wiki/Plantilla:es.v.conj.-ie-ue-.er , https://es.wiktionary.org/wiki/Plantilla:es.v.conj.-ie-ue-.ar
	const result={...dict}
	for (const formId of ['pres1s','pres2s','pres3s','pres3p','im2s','im3s','im3p']) {
		result[formId]=v2replaceLastStemVowel(result[formId],v,V)
	}
	return result
}
const v2vowelIr=(v,V,va,dict)=>{ // https://es.wiktionary.org/wiki/Plantilla:es.v.conj.-ie-i-ue-u-.ir
	const result={...dict}
	for (const formId of ['pres1s','pres2s','pres3s','pres3p','im2s','im3s','im3p']) {
		result[formId]=v2replaceLastStemVowel(result[formId],v,V)
	}
	for (const formId of ['ger','pret3s','pret3p','im1p']) {
		result[formId]=v2replaceLastStemVowel(result[formId],v,va)
	}
	return result
}
const v2yoHandler=(dict,replacementFn,note)=>{ // TODO? yo -go-глаголы часто имеют im2s без окончания
	const result={...dict}
	for (const formId of ['pres1s','im3s','im1p','im3p']) {
		result[formId]=[replacementFn(result[formId]),note]
	}
	return result
}
const v2yo=(stem,dict)=>v2yoHandler(dict,s=>s.replace(/^.*?\|/,stem+'|'))
const v2yojo=(dict)=>v2yoHandler(dict,s=>s.replace(/^.*?\|/,
	dict.pres1s.split('|')[0].replace(/g$/,'[j]')+'|'
),'у -ger и -gir-глаголов для yo в настоящем времени -g- в корне меняется на -j-')
const v2yendo=(dict)=>{
	const result={...dict}
	for (const formId of ['ger','pret3s','pret3p']) {
		result[formId]=result[formId].replace(/\|i/,'|[y]')
	}
	for (const formId of ['par','pret2s','pret1p','pret2p']) {
		result[formId]=result[formId].replace(/\|i/,'|[í]')
	}
	result.ger=[result.ger,'после гласной -iendo меняется на -yendo']
	return result
}
const v2pret=(strongStem,dict)=>{ // TODO make note: https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Pret%C3%A9ritos_fuertes
	const result={...dict}
	const ends='e,iste,o,imos,isteis,ieron'.split(',')
	const markEnds      ='[e],[i]ste,[o],[i]mos,[i]steis,[ie]ron'.split(',')
	const markInsertEnds='{e},{i}ste,{o},{i}mos,{i}steis,{ie}ron'.split(',')
	for (const [i,formId] of v2formIds('pret**').entries()) {
		const [,end]=result[formId].split('|')
		let strongEnd=end
		if (end!=ends[i]) {
			if (end.length==ends[i].length) {
				strongEnd=markEnds[i]
			} else {
				strongEnd=markInsertEnds[i]
			}
		}
		result[formId]=strongStem+'|'+strongEnd
	}
	return result
}
const v2imp=(stem,dict)=>{
	const result={...dict}
	for (const formId of v2formIds('imp**')) {
		result[formId]=result[formId].replace(/^.*?\|/,`${stem}|`)
	}
	return result
}
const v2fut=(stem,dict)=>{
	const result={...dict}
	for (const formId of v2formIds('fut**')) {
		result[formId]=result[formId].replace(/^.*\|.*\|/,`${stem}|{}r|`)
	}
	return result
}
const v2tov3=(data)=>data.map(entry=>{
	if (!Array.isArray(entry)) return entry
	const verb=new Verb('xar','')
	verb.forms={}
	let forms
	;[verb.title,forms,verb.translation,verb.category]=entry
	for (const [formId,form] of Object.entries(forms)) {
		if (Array.isArray(form)) {
			;[verb.forms[formId],verb.formNotes[formId]]=form
		} else {
			verb.forms[formId]=form
		}
	}
	return verb
})
class Verb {
	constructor(title,translation,category) {
		this.title=title
		this.translation=translation
		this.category=category
		this.forms={}
		this.formNotes={}
		const [infStem,infEnd]=title.split(/(..)$/)
		const formIds=(
			'inf,ger,par,'+
			'pres1s,pres2s,pres3s,pres1p,pres2p,pres3p,'+
			'pret1s,pret2s,pret3s,pret1p,pret2p,pret3p,'+
			'imp1s,imp2s,imp3s,imp1p,imp2p,imp3p,'+
			'fut1s,fut2s,fut3s,fut1p,fut2p,fut3p,'+
			'cond1s,cond2s,cond3s,cond1p,cond2p,cond3p,'+
			'subj1s,subj2s,subj3s,subj1p,subj2p,subj3p,'+
			'im2s,im3s,im1p,im2p,im3p'
		).split(',')
		const formEndsFut=(e)=>`${e}|é,${e}|ás,${e}|á,${e}|emos,${e}|éis,${e}|án,`
		const formEndsCond=(e)=>`${e}|ía,${e}|ías,${e}|ía,${e}|íamos,${e}|íais,${e}|ían,`
		const formEndsPretEir='í,iste,ió,imos,isteis,ieron,'
		const formEndsImpEir='í|a,í|as,í|a,í|amos,í|ais,í|an,'
		const formEnds={
		ar:(
			'ar,ando,ado,'+
			'o,as,a,amos,áis,an,'+
			'é,aste,ó,amos,asteis,aron,'+
			'ab|a,ab|as,ab|a,áb|amos,ab|ais,ab|an,'+
			formEndsFut('ar')+
			formEndsCond('ar')+
			'e,es,e,emos,éis,en,'+
			'a,e,emos,ad,en'
		).split(','),
		er:(
			'er,iendo,ido,'+
			'o,es,e,emos,éis,en,'+
			formEndsPretEir+
			formEndsImpEir+
			formEndsFut('er')+
			formEndsCond('er')+
			'a,as,a,amos,áis,an,'+
			'e,a,amos,ed,an'
		).split(','),
		ir:(
			'ir,iendo,ido,'+
			'o,es,e,imos,ís,en,'+
			formEndsPretEir+
			formEndsImpEir+
			formEndsFut('ir')+
			formEndsCond('ir')+
			'a,as,a,amos,áis,an,'+
			'e,a,amos,id,an'
		).split(','),
		}[infEnd]
		for (const [i,formId] of formIds.entries()) {
			let stem=infStem
			let end=formEnds[i]
			if (infEnd[0]=='a') { // https://es.wiktionary.org/wiki/Plantilla:mutacion.es.nexo.aou
				const replacements={c:'qu',z:'c',gu:'gü',g:'gu'}
				const stemMatch=stem.match(new RegExp(Object.keys(replacements).join('|')+'$'))
				const endMatch=end.match(/^[eéií]/)
				if (stemMatch && endMatch) {
					const [s]=stemMatch
					const [e]=endMatch
					const r=replacements[s]
					stem=stem.replace(new RegExp(s+'$'),r.length==1?'['+r+']':'{'+r+'}')
					this.formNotes[formId]=`у -${s}${infEnd}-глаголов -${s}${e}- меняется на -${r}${e}-`
				}
			}
			this.forms[formId]=stem+'|'+end
		}
	}
	replaceLastStemVowel(formId,v) {
		let replacement='['+v+']'
		if (v.length>1) replacement='{'+v+'}'
		const [oldStem,end]=this.forms[formId].split(/\|(.*)/)
		let i=oldStem.length-1
		for (;i>=0;i--) {
			if ('aeio'.includes(oldStem[i]) || oldStem[i]=='u' && oldStem[i-1]!='g') break
		}
		const newStem=oldStem.slice(0,i)+replacement+oldStem.slice(i+1)
		this.forms[formId]=newStem+'|'+end
	}
	vowel(v,va) {
		for (const formId of [ // https://es.wiktionary.org/wiki/Plantilla:es.v.conj.-ie-ue-.er , https://es.wiktionary.org/wiki/Plantilla:es.v.conj.-ie-ue-.ar
			'pres1s','pres2s','pres3s','pres3p',
			'subj1s','subj2s','subj3s','subj3p',
			'im2s','im3s','im3p'
		]) {
			this.replaceLastStemVowel(formId,v)
		}
		if (va===undefined) return this
		for (const formId of ['ger','pret3s','pret3p','subj1p','subj2p','im1p']) { // https://es.wiktionary.org/wiki/Plantilla:es.v.conj.-ie-i-ue-u-.ir
			this.replaceLastStemVowel(formId,va)
		}
		return this
	}
	getRawForm(formId) {
		return this.forms[formId].replace(/[|{}[\]]/g,'')
	}
}
const v3=(...args)=>(new Verb(...args))
const verbsData=v2tov3([
	// regular
	v3('hablar','говорить',['1ª <abbr title=conjugación>conj.</abbr>','Primera conjugación, правильный -ar-глагол']),
	v3('comer','есть',['2ª <abbr title=conjugación>conj.</abbr>','Segunda conjugación, правильный -er-глагол']),
	v3('vivir','жить',['3ª <abbr title=conjugación>conj.</abbr>','Tercera conjugación, правильный -ir-глагол']),
	// orthographic
	v3('tocar','трогать','c→<strong class=insert>qu</strong>'),
	v3('utilizar','использовать','z→<strong>c</strong>'),
	v3('llegar','прибывать','g→<strong class=insert>gu</strong>'),
	// helper
	['estar',{...v2pret('est{uv}',v2('estar')),
		...v2repl('pres*s','est|o{y},est|[á]s,est|[á]'),
		pres3p:'est|[á]n',
		im2s:'est|[á]',im3s:'est|[é]',im3p:'est|[é]n',
	},['быть','быть временно, быть в указанном месте']],
	['ser',{...v2yo('s{e}',v2('ser')),
		...v2repl('pres**','s|o{y},{er}|es,{es}|[],s|[o]mos,s|[o]is,s|[o]n'),
		...v2repl('pret**','{fu}|[i],{fu}|iste,{fu}|[e],{fu}|imos,{fu}|isteis,{fu}|{}eron'),
		...v2repl('imp**','{er}|{}|a,{er}|{}|as,{er}|{}|a,{ér}|{}|amos,{er}|{}|ais,{er}|{}|an'),
		im2s:'s|[é]',
	},['быть','быть постоянно, быть в указанный момент времени']],
	['ir',{...v2yo('{vay}',v2('ir')),
		ger:'|[y]endo',
		...v2repl('pres**','{v}|o{y},{v}|[a]s,{v}|[a],{v}|[a]mos,{v}|{ai}s,{v}|[a]n'),
		...v2repl('pret**','{fu}|[i],{fu}|iste,{fu}|[e],{fu}|imos,{fu}|isteis,{fu}|{}eron'),
		...v2repl('imp**','{ib}|{}|a,{ib}|{}|as,{ib}|{}|a,{íb}|{}|amos,{ib}|{}|ais,{ib}|{}|an'),
		im2s:'{v}|e',
	},'идти'],
	['haber',{...v2fut('hab',v2pret('h[u]b',v2yo('ha[y]',v2('haber')))),
		...v2repl('pres**','h{}|[e],h{}|[a]s,h{}|[a],h{}|emos,hab|éis,h{}|[a]n'),
		im2s:'h{}|e',
	},['иметь','вспомогательный для сложных времён']],
	// vowel change - https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Verbos_con_alternancia_voc%C3%A1lica
	v3('pensar','думать','e→<strong class=insert>ie</strong>').vowel('ie'),
	v3('sentir','чувствовать','e→<strong class=insert>ie</strong>,<strong>i</strong>').vowel('ie','i'),
	['pedir',v2vowelIr('e','i','i',v2('pedir')),'просить','e→<strong>i</strong>'], // {{es.v.conj.-ie-i-ue-u-.ir|ped|pid|pid}}
	v3('mover','двигать','o→<strong class=insert>ue</strong>').vowel('ue'),
	['dormir',v2vowelIr('o','ue','u',v2('dormir')),'спать','o→<strong class=insert>ue</strong>,<strong>u</strong>'], // {{es.v.conj.-ie-i-ue-u-.ir|dorm|duerm|durm}}
	v3('jugar','играть','u→<strong class=insert>ue</strong>').vowel('ue'),
	// consonant change
	['conocer',v2yo('cono{zc}',v2('conocer')),['знать','знать человека/место'],'c→<strong class=insert>zc</strong>'], // {{es.v.conj.zc.cer|cono}}
	['conducir',{...v2pret('condu[j]',v2yo('condu{zc}',v2('conducir'))),
		pret3p:'conduj|{}eron',
	},'вести','c→<strong class=insert>zc</strong>,<strong>j</strong>'], // {{es.v.conj.ducir|condu}}
	// other rules - https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Verbos_con_participio_irregular
	['creer',v2yendo(v2('creer')),'верить','-<strong>y</strong>endo'], // {{es.v.conj.eer|cre}}
	['escribir',{...v2('escribir'),
		par:'escri[t]|{}o',
	},'писать','<abbr title=participio>part.</abbr> <abbr title=irregular>irreg.</abbr>'], // {{es.v.conj.ir|escrib|part=escrito}}
	// unsorted
	['dar',{...v2pret('d',v2('dar')), // легче посчитать за сильный претерит, хотя викисловарь так не считает
		pres1s:'d|o{y}',
		pres2p:'d|[a]is',
		pret1s:'d|[i]',
		pret3s:'d|{io}',
		im3s:'d|[é]',
	},'давать'],
	['leer',v2yendo(v2('leer')),'читать'],
	['ver',{...v2imp('v{e}',v2yo('v{e}',v2('ver'))),
		par:'v|i{st}o',
		pres2p:'v|[e]is',
		pret1s:'v|[i]',
		pret3s:'v|i[o]',
	},'видеть'],
	['venir',{...v2fut('ven{d}',v2pret('v[i]n',v2yo('ven{g}',v2vowelIr('e','ie','i',v2('venir'))))),
		im2s:'ven|{}',
	},'приходить'], // {{es.v.conj.venir}}
	['hacer',{...v2fut('ha{}',v2pret('h[i]c',v2yo('ha[g]',v2('hacer')))),
		par:'h{ech}|{}o',
		pret3s:'h[iz]|[o]',
		im2s:'ha[z]|{}',
	},'делать'],
	['poner',{...v2fut('pon{d}',v2pret('p[us]',v2yo('pon{g}',v2('poner')))),
		par:'p{uest}|{}o',
		im2s:'pon|{}',
	},'ставить'],
	['tener',{...v2fut('ten{d}',v2pret('t[uv]',v2yo('ten{g}',v2vowel('e','ie',v2('tener'))))),
		im2s:'ten|{}',
	},'иметь'], // {{es.v.conj.tener}}
	['saber',{...v2fut('sab',v2pret('s[up]',v2yo('s[ep]',v2('saber')))),
		pres1s:'s{}|[é]',
	},['знать','знать факт/навык']],
	['traer',{...v2pret('tra{j}',v2yo('tra{ig}',v2('traer'))),
		pret3p:'tra{j}|{}eron',
	},'приносить'],
	['coger',v2yojo(v2('coger')),'брать'],
	['elegir',{...v2yojo(v2vowelIr('e','i','i',v2('elegir'))),
		par:'ele{ct}|{}o',
	},'выбирать'], // {{es.v.conj.-ie-i-ue-u-.ir|ele|eli|eli|nexo=g|part=electo|part2=elegido}}
	['seguir',v2yo('s[i]g{}',v2vowelIr('e','i','i',v2('seguir'))),'следовать'], // {{es.v.conj.seguir}}
	['poder',{...v2fut('pod',v2pret('p[u]d',v2vowel('o','ue',v2('poder')))),
		ger:'p[u]d|iendo',
	},'мочь'], // {{es.v.conj.er|pod|irregular=x|...}}
	v3('empezar','начинать').vowel('ie'),
	['oír',{...v2yendo(v2yo('o{ig}',v2vowel('o','oy',v2('oir')))),
		inf:'o|[í]r',
		pres1p:'o|[í]mos',
		im2p:'o|[í]d',
	},'слышать'], // {{es.v.conj.oír|o}}
	['querer',v2fut('quer',v2pret('qu[is]',v2vowel('e','ie',v2('querer')))),'хотеть'], // {{es.v.conj.querer}}
	['salir',{...v2fut('sal{d}',v2yo('sal{g}',v2('salir'))),
		im2s:'sal|{}',
	},'выходить'], // {{es.v.conj.salir}}
	['decir',{...v2fut('d[i]{}',v2pret('d[ij]',v2yo('d[ig]',v2vowelIr('e','i','i',v2('decir'))))),
		im2s:'d[i]{}|{}',
		par:'d{ich}|{}o',
	},'сказать'], // {{es.v.conj.decir}}
	['volver',{...v2vowel('o','ue',v2('volver')),
		par:'v{ue}l[t]|{}o',
	},'возвращаться'], // {{es.v.conj.-ie-ue-.er|volv|vuelv|part=vuelto}}
	['pasar',v2('pasar'),'проходить'], // {{es.v.conj.ar|pas}}
	['deber',v2('deber'),'быть должным'], // {{es.v.conj.er|deb}}
	['parecer',v2yo('pare{zc}',v2('parecer')),'казаться'], // {{es.v.conj.zc.cer|pare}}
	['quedar',v2('quedar'),'оставаться'], // {{es.v.conj.ar|qued}}
])
//for (let i=0;i<verbs.length;i+=2) {
//	const [inf]=verbs[i]
//	verbs.splice(i+1,0,[inf,v2(inf.replace('í','i')),'TEST','TEST'])
//} // for debugging
const verbsByFrequency=(
	'ser,haber,estar,tener,hacer,poder,decir,ir,ver,dar,'+
	'saber,querer,llegar,pasar,deber,poner,parecer,quedar,creer,hablar'
).split(',') // Mark Davies, A Frequency Dictionary of Spanish, 2006

const readPair=(a)=>Array.isArray(a)?a:[a,'']

const getVerbFormOrder=(sortType,formSet)=>{
	const a=[] // [formGroupId, [[isCompactable,formId], ...]], ...
	{
		formGroupId='nonpers'
		const formGroupRows=[]
		for (const formId of ['inf','ger','par']) {
			if (formId in formSet && !formSet[formId]) continue
			formGroupRows.push([0,formId])
		}
		a.push([formGroupId,formGroupRows])
	}
	for (const formGroupId of personalVerbForms) {
		if (formGroupId in formSet && !formSet[formGroupId]) continue
		const formGroupRows=[]
		if (sortType!='number') {
			for (const p of [1,2,3]) {
				if (sortType=='person-compact' && formGroupId+p in compactableVerbForms) {
					formGroupRows.push([1,formGroupId+p])
					continue
				}
				for (const n of ['s','p']) {
					if (verbForms[formGroupId+p+n]) formGroupRows.push([0,formGroupId+p+n])
				}
			}
		} else {
			for (const n of ['s','p']) {
				for (const p of [1,2,3]) {
					if (verbForms[formGroupId+p+n]) formGroupRows.push([0,formGroupId+p+n])
				}
			}
		}
		a.push([formGroupId,formGroupRows])
	}
	return a
}

function createConjugationTable($container,sortType,formSet,orderType) {
	let verbs=verbsData
	if (orderType=='frequency') { // hack
		verbs=[]
		for (const v of verbsByFrequency) {
			for (const verb of verbsData) {
				if (verb.title==v) {
					verbs.push(verb)
					continue
				}
			}
		}
	}
	function cellClickHandler() {
		if (this.dataset.formId2) {
			this.classList.add('combination')
		}
	}
	function cellAnimationEndHandler() {
		this.classList.remove('combination')
	}
	$container.classList.add('conjtable')
	const $table=document.createElement('table')
	$table.setAttribute('lang','es')
	const $thead=document.createElement('thead')
	$table.appendChild($thead)
	{
		const $row=$thead.insertRow()
		$row.innerHTML="<th colspan=2>"
		for (const [i,verb] of verbs.entries()) {
			let [title,titleNote]=readPair(verb.category)
			if (orderType=='frequency') {
				title=i+1
				titleNote=undefined
			}
			const $cell=document.createElement('th')
			$row.appendChild($cell)
			if (title) $cell.innerHTML=title
			if (titleNote) $cell.setAttribute('title',titleNote)
		}
	}
	for (const [formGroupId,formGroupRows] of getVerbFormOrder(sortType,formSet)) {
		const [formGroupName]=verbForms[formGroupId]
		const $tbody=document.createElement('tbody')
		$table.appendChild($tbody)
		let firstInGroup=true
		for (const [compactRow,formId] of formGroupRows) {
			const $row=$tbody.insertRow()
			if (!compactRow && sortType!='number') {
				$row.classList.add('number-'+formId.slice(-1))
			}
			if (firstInGroup && formGroupName) {
				let cls='group'
				if (formGroupRows.length<5 && formGroupName.length>10) cls="'group long'"
				if (formGroupRows.length<4 && formGroupName.length>10) cls="'group very-long'"
				$row.insertAdjacentHTML('beforeend',`<th class=${cls} rowspan=${formGroupRows.length}><span>${formGroupName}</span>`)
			}
			firstInGroup=false
			const [formText,formNote]=(compactRow?compactableVerbForms:verbForms)[formId]
			const $formCell=document.createElement('th')
			if (!formGroupName) $formCell.setAttribute('colspan',2)
			$row.appendChild($formCell)
			$formCell.innerHTML=formText
			$formCell.setAttribute('title',formNote)
			const formRawText=formText.replace(/<[^>]*>/g,'')
			if (formGroupName && formRawText.length>10) {
				$formCell.classList.add('very-long')
			} else if (formGroupName && formRawText.length>5) {
				$formCell.classList.add('long')
			}
			const getFormHtml=(form)=>{
				if (form===undefined) return ''
				const [stem,end,subend]=form.split('|')
				const mark=(s)=>s.replace(/\[(.*?)\]/g,'<strong>$1</strong>').replace(/\{(.*?)\}/g,'<strong class=insert>$1</strong>')
				const makeSpan=(cls,s)=>s?`<span class=${cls}>${mark(s)}</span>`:''
				let t=makeSpan('stem',stem)+makeSpan('end',end)
				if (subend!==undefined) t+=makeSpan('subend',subend)
				return t
			}
			const combineForms=(shortForm,longForm)=>{
				const d=longForm.length-shortForm.length
				let i=0
				for (;i<shortForm.length;i++) {
					if (shortForm[i]!=longForm[i]) break
				}
				let j=shortForm.length-1
				for (;j>=0;j--) {
					if (shortForm[j]!=longForm[j+d]) break
				}
				if (i!=j+1) return [false]
				return [true,longForm.slice(0,i),longForm.slice(i,i+d),longForm.slice(i+d)]
			}
			for (const verb of verbs) {
				const $cell=$row.insertCell()
				if (compactRow) {
					const form1=verb.forms[formId+'s']
					const form2=verb.forms[formId+'p']
					if (form1 && form2) {
						const [isCombined,preMarked,inMarked,postMarked]=combineForms(form1,form2)
						if (isCombined) {
							$cell.innerHTML=getFormHtml(`${preMarked}<em>${inMarked}</em>${postMarked}`)
						} else {
							$cell.innerHTML=getFormHtml(form1)+" / "+getFormHtml(form2)
						}
					}
					const formNote1=verb.formNotes[formId+'s']
					const formNote2=verb.formNotes[formId+'p']
					let formNote
					if (formNote1 && formNote2) {
						if (formNote1==formNote2) {
							formNote=formNote1
						} else {
							formNote=formNote1+' / '+formNote2
						}
					} else {
						formNote=formNote1||formNote2
					}
					if (formNote) $cell.setAttribute('title',formNote)
					$cell.dataset.formId=formId+'s'
					$cell.dataset.formId2=formId+'p'
				} else {
					$cell.innerHTML=getFormHtml(verb.forms[formId])
					if (verb.formNotes[formId]) $cell.setAttribute('title',verb.formNotes[formId])
					$cell.dataset.formId=formId
				}
				$cell.dataset.verb=verb
				$cell.addEventListener('click',cellClickHandler)
				$cell.addEventListener('animationend',cellAnimationEndHandler)
			}
		}
	}
	{
		const $tbody=document.createElement('tbody')
		$table.appendChild($tbody)
		{
			const $row=$tbody.insertRow()
			$row.setAttribute('lang','ru')
			const $cell=document.createElement('th')
			$cell.setAttribute('colspan',2)
			$row.appendChild($cell)
			for (const verb of verbs) {
				const [translation,translationNote]=readPair(verb.translation)
				const $cell=$row.insertCell()
				$cell.innerHTML=translation
				if (translationNote) $cell.setAttribute('title',translationNote)
			}
		}
		{
			const $row=$tbody.insertRow()
			const $cell=document.createElement('th')
			$cell.setAttribute('colspan',2)
			$row.appendChild($cell)
			for (const verb of verbs) {
				$row.insertCell().innerHTML="<a href=https://es.wiktionary.org/wiki/"+verb.title+"#Conjugaci%C3%B3n>[w]</a>"
			}
		}
	}
	$container.appendChild($table)
}

function createConjugationGame($container,formSet) {
	let verbs=verbsData // hack
	const gameVerbs=[]
	for (const verb of verbs) {
		for (const formId in verb.forms) {
			if (formId=='inf') continue
			if (formId in formSet && !formSet[formId]) continue
			const [formGroupId,]=formId.split(/(\d)/)
			if (formGroupId in formSet && !formSet[formGroupId]) continue
			gameVerbs.push([verb,formId])
		}
	}
	const shuffle=(a)=>{
		let i=a.length
		while (i>0) {
			let j=Math.floor(Math.random()*i)
			i-=1
			;[a[i],a[j]]=[a[j],a[i]]
		}
	}
	shuffle(gameVerbs)
	let iCurrentGameVerb=0
	$container.classList.add('conjgame')
	const $table=document.createElement('table')
	$container.appendChild($table)
	const createNextQuestion=()=>{
		if (iCurrentGameVerb>=gameVerbs.length) return
		const [verb,formId]=gameVerbs[iCurrentGameVerb]
		const $tbody=document.createElement('tbody')
		$table.appendChild($tbody)
		const $infRow=$tbody.insertRow()
		$infRow.insertAdjacentHTML('beforeend',"<th colspan=2>")
		$infRow.insertCell().innerHTML=verb.title
		const $formRow=$tbody.insertRow()
		const [formGroupId,n]=formId.split(/(\d)/)
		if (n) {
			const [,formGroupTitle]=verbForms[formGroupId]
			const [formTitle]=verbForms[formId]
			$formRow.insertAdjacentHTML('beforeend',`<th>${formGroupTitle},<th>${formTitle}`)
		} else {
			const [formTitle]=verbForms[formId]
			$formRow.insertAdjacentHTML('beforeend',`<th colspan=2>${formTitle}`)
		}
		const $formInputTd=$formRow.insertCell()
		const $formInput=document.createElement('input')
		$formInputTd.appendChild($formInput)
		const $formButtonTd=$formRow.insertCell()
		const $formButton=document.createElement('button')
		$formButton.innerHTML='Проверить'
		$formButtonTd.appendChild($formButton)
		$formButton.addEventListener('click',()=>{
			const userForm=$formInput.value
			$formInputTd.removeChild($formInput)
			$formButtonTd.removeChild($formButton)
			$formInputTd.insertAdjacentText('beforeend',userForm)
			const form=verb.getRawForm(formId)
			if (userForm==form) {
				$formButtonTd.insertAdjacentHTML('beforeend',"<span class=correct>Правильно</span>")
			} else {
				$formButtonTd.insertAdjacentHTML('beforeend',"<span class=incorrect>Неправильно</span>")
				$tbody.insertRow().innerHTML=`<th colspan=2>Правильный ответ<td>${form}`
			}
			iCurrentGameVerb++
			createNextQuestion()
		})
	}
	createNextQuestion()
}

function createOptions($featureContainer,$optionsContainer) {
	const $openerContainer=document.createElement('div')
	$openerContainer.classList.add('opener')
	$optionsContainer.appendChild($openerContainer)
	const $dialog=document.createElement('div')
	$dialog.classList.add('dialog')
	$optionsContainer.appendChild($dialog)
	const $closerContainer=document.createElement('div')
	$closerContainer.classList.add('closer')
	$dialog.appendChild($closerContainer)
	let feature=localStorage.getItem('glaconjurer-feature') || 'conjtable'
	let sort=localStorage.getItem('glaconjurer-sort') || 'number'
	let order=localStorage.getItem('glaconjurer-order') || 'topic'
	let forms={}
	const formFilterIds=['par','ger',...personalVerbForms]
	for (const formId of formFilterIds) {
		const v=localStorage.getItem('glaconjurer-form-'+formId)
		forms[formId]=v!='0'
	}
	const createFeature=()=>{
		while ($featureContainer.firstChild) $featureContainer.removeChild($featureContainer.firstChild)
		$featureContainer.className=''
		if (feature=='conjgame') {
			createConjugationGame($featureContainer,forms)
		} else {
			createConjugationTable($featureContainer,sort,forms,order)
		}
	}
	createFeature()
	let needToCreateFeature=false
	const createBlock=(title,labelFor)=>{
		const $block=document.createElement('div')
		$block.classList.add('block')
		if (labelFor) {
			$block.innerHTML=`<div><label for=${labelFor}>${title}:</label></div>`
		} else {
			$block.innerHTML=`<div>${title}:</div>`
		}
		$dialog.appendChild($block)
		return $block
	}
	const createControl=($block,html,handler)=>{
		const $control=document.createElement('div')
		$control.innerHTML=html
		$control.addEventListener('change',handler)
		$block.appendChild($control)
	}
	{
		const $block=createBlock("Режим",'options-feature')
		createControl($block,"<select id=options-feature>"+[
			['conjtable','таблица спряжений'],
			['conjgame','игра'],
		].map(([value,text])=>`<option value=${value+(value==feature?' selected':'')}>${text}</option>`).join('')+"</select>",(ev)=>{
			feature=ev.target.value
			localStorage.setItem('glaconjurer-feature',feature)
			needToCreateFeature=true
		})
	}{
		const $block=createBlock("Отображение спряжений по лицам и числам")
		const handler=(ev)=>{
			sort=ev.target.value
			localStorage.setItem('glaconjurer-sort',sort)
			if (feature=='conjtable') needToCreateFeature=true
		}
		for (const [value,text] of [
			['number','обычный порядок'],
			['person','группировка по лицам'],
			['person-compact','...с уплотнением'],
		]) createControl($block,
			`<label><input type=radio name=sort value=${value+(value==sort?' checked':'')}> ${text}</label>`,
		handler)
	}{
		const $block=createBlock("Формы глаголов")
		const handler=(ev)=>{
			forms[ev.target.value]=ev.target.checked
			localStorage.setItem('glaconjurer-form-'+ev.target.value,ev.target.checked?'1':'0')
			needToCreateFeature=true
		}
		for (const value of formFilterIds) createControl($block,
			`<label><input type=checkbox value=${value+(forms[value]?' checked':'')}> ${verbForms[value][0]}</label>`,
		handler)
	}{
		const $block=createBlock("Порядок и набор глаголов")
		const handler=(ev)=>{
			order=ev.target.value
			localStorage.setItem('glaconjurer-order',order)
			if (feature=='conjtable') needToCreateFeature=true
		}
		for (const [value,text] of [
			['topic','по видам спряжений глаголов'],
			['frequency','по частоте употребления'],
		]) createControl($block,
			`<label><input type=radio name=order value=${value+(value==order?' checked':'')}> ${text}</label>`,
		handler)
	}
	const $openerButton=document.createElement('button')
	$openerButton.innerHTML='Настройки'
	$openerContainer.appendChild($openerButton)
	$openerButton.addEventListener('click',()=>{
		$dialog.classList.add('open')
	})
	const $closerButton=document.createElement('button')
	$closerButton.innerHTML='Назад'
	$closerContainer.appendChild($closerButton)
	$closerButton.addEventListener('click',()=>{
		if (needToCreateFeature) {
			needToCreateFeature=false
			createFeature()
		}
		$dialog.classList.remove('open')
	})
}

const $body=document.getElementsByTagName('body')[0]
const $featureContainer=document.createElement('div')
$featureContainer.id='feature'
$body.appendChild($featureContainer)
const $optionsContainer=document.createElement('div')
$optionsContainer.id='options'
$body.appendChild($optionsContainer)
createOptions($featureContainer,$optionsContainer)

</script>
</body>
</html>
