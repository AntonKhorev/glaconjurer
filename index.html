<!DOCTYPE html>
<html lang='ru'>
<head>
<meta charset='utf-8' />
<style>
body {
	font-family: sans-serif;
}
table {
	border-collapse: collapse;
}
tbody {
	border-top: solid 1px gray;
}
td, th {
	text-align: left;
	padding: .2em;
	font-weight: normal;
}
td {
	white-space: nowrap;
}
tr.number-s td, tr.number-s th {
	padding-bottom: 0;
}
tr.number-p:not(:first-child) td, tr.number-p:not(:first-child) th {
	padding-top: 0;
}
th.group {
	min-width: 1em;
}
th.group span {
	writing-mode: vertical-rl;
	transform: rotate(180deg);
}
td[title], th[title] {
	text-decoration: underline dotted;
}
[class|=stem] {
	border-right: solid 1px green;
	padding: .22em .05em .22em 0;
}
[class|=end] {
	font-weight: bold;
	border-left: solid 1px green;
	padding: .22em 0 .22em .05em;
}
[class|=subend] {
	color: #333;
	font-weight: bold;
	border-left: solid 1px #DDD;
	padding: .22em 0 .22em .05em;
}
[class|=stem] + [class|=end] {
	border: none;
}
.stem-2, .end-2 {
	border-color: red;
}
[class|=stem] strong {
	font-weight: normal;
}
[class|=end] strong {
	font-weight: bold;
}
.stem-1 strong, .end-1 strong {
	color: green;
}
.stem-2 strong, .end-2 strong {
	color: red;
}
.stem-1 strong:empty, .end-1 strong:empty, .stem-2 strong:empty, .end-2 strong:empty {
	display: inline-block;
	width: .5ex;
}
.stem-1 strong:empty, .end-1 strong:empty {
	border-bottom: solid 1px green;
}
.stem-2 strong:empty, .end-2 strong:empty {
	border-bottom: solid 1px red;
}
</style>
</head>
<body>
<script>
const verbFormOrder=[
	['',['inf','ger','par']],
	['pres'],
	['pret'],
	['imp'],
	['fut'],
	['im'],
]
const verbFormGroups={
	pres: ['Presente','Presente'],
	pret: ['Pretérito','Pretérito indefinido'],
	imp: ['<abbr title=Pretérito>Pr.</abbr> imperfecto','Pretérito imperfecto'],
	fut: ['Futuro','Futuro'],
	im: ['Imperativo','Imperativo'],
}
const verbForms={
	inf: ['Infinitivo','инфинитив'],
	ger: ['Gerundio','для образования аналога continuous в английском по схеме спряжённый-estar + Ger. ("estoy estudiando" = "I am studying")'],
	par: ['Participio','страдательное(?) причастие прошедшего времени, меняется по родам и числам (apagado = выключенный, apagada = выключенная)'],
	im2s: ['tú','tú: ты сделай; форма глагола обычно совпадает с 3-м лицом ед. ч. Presente'],
	im3s: ['usted','usted: (вежливое) вы сделайте; форма глагола обычно совпадает императивом для tú, только окончание a меняется на e и наоборот'],
	im1p: ['nosotros','nosotros, nosotras: давайте мы сделаем'],
	im2p: ['vosotros','vosotros, vosotras: (множественное) вы сделайте'],
	im3p: ['ustedes','ustedes: (вежливое множественное) вы сделайте'],
}
for (const [prefix,[v1s,v2s,v3sm,v3sf,v1p,v2p,v3p]] of [
	['pres',['делаю','делаешь','делает','делает','делаем','делаете','делают']],
	['pret',['сделал(а)','сделал(а)','сделал','сделала','сделали','сделали','сделали']],
	['fut' ,['сделаю','сделаешь','сделает','сделает','сделаем','сделаете','сделают']],
	['imp' ,['делал(а)','делал(а)','делал','делала','делали','делали','делали']],
]) {
	verbForms[prefix+'1s']=['yo',`yo: я ${v1s}`]
	verbForms[prefix+'2s']=['tú',`tú: ты ${v2s}`]
	verbForms[prefix+'3s']=['él',`él: он ${v3sm}; ella: она ${v3sf}; usted: (вежливое) вы ${v2p}`]
	verbForms[prefix+'1p']=['nosotros',`nosotros, nosotras: мы ${v1p}`]
	verbForms[prefix+'2p']=['vosotros',`vosotros, vosotras: (множественное) вы ${v2p}`]
	verbForms[prefix+'3p']=['ellos',`ellos, ellas: они ${v3p}; ustedes: (вежливое множественное) вы ${v2p}`]
}
const compactableVerbForms={
	pres3: ['él<em>los</em>',verbForms['pres3s'][1]+'; '+verbForms['pres3p'][1]],
	pret2: ['tú',verbForms['pret2s'][1]+'; '+verbForms['pret2p'][1]],
	imp3: ['él<em>los</em>',verbForms['imp3s'][1]+'; '+verbForms['imp3p'][1]],
	fut3: ['él<em>los</em>',verbForms['fut3s'][1]+'; '+verbForms['fut3p'][1]],
	im3: ['usted<em>es</em>','usted, ustedes: (вежливое) вы сделайте'],
}
const v1=(...aa)=>{
	const a=[].concat.apply([],aa.map(s=>Array.isArray(s)?[s]:s.split(',')))
	return [
		'inf','ger','par',
		'pres1s','pres2s','pres3s','pres1p','pres2p','pres3p',
		'pret1s','pret2s','pret3s','pret1p','pret2p','pret3p',
		'imp1s','imp2s','imp3s','imp1p','imp2p','imp3p',
		'im2s','im3s','im1p','im2p','im3p'
	].reduce((o,k,i)=>({...o,[k]:a[i]}),{})
}
const v1forms=(inf,ar,er,ir,yoException)=>{
	const [stem,end]=inf.split(/(..)$/)
	const gen=a=>a.split(',').map(s=>`${stem}|${s}`)
	let result
	if (end=='ar') {
		result=gen(ar)
	} else if (end=='er') {
		result=gen(er)
	} else if (end=='ir') {
		result=gen(ir)
	} else {
		throw 'unrecognized verb form'
	}
	if (yoException) result[0]=yoException
	return result.join(',')
}
const v1pres=(inf,yoException)=>v1forms(inf,
	'o,as,a,amos,áis,an',
	'o,es,e,emos,éis,en',
	'o,es,e,imos,ís,en',
	yoException
)
const v1pret=(inf)=>v1forms(inf,
	'é,aste,ó,amos,asteis,aron',
	'í,iste,ió,imos,isteis,ieron',
	'í,iste,ió,imos,isteis,ieron',
)
const v1imp=(inf)=>v1forms(inf,
	'ab|a,ab|as,ab|a,áb|amos,ab|ais,ab|an',
	'í|a,í|as,í|a,í|amos,í|ais,í|an',
	'í|a,í|as,í|a,í|amos,í|ais,í|an',
)
const v1yendo=(inf)=>[`${inf.slice(0,-2)}|[y]endo`,'после гласной -iendo меняется на -yendo']
const v1jo=(inf)=>[`${inf.slice(0,-3)}[j]|o`,'у -ger и -gir-глаголов вместо -go пишется -jo']
const v2=(inf)=>{
	const [stem,infEnd]=inf.split(/(..)$/)
	const formIds=(
		'inf,ger,par,'+
		'pres1s,pres2s,pres3s,pres1p,pres2p,pres3p,'+
		'pret1s,pret2s,pret3s,pret1p,pret2p,pret3p,'+
		'imp1s,imp2s,imp3s,imp1p,imp2p,imp3p,'+
		'fut1s,fut2s,fut3s,fut1p,fut2p,fut3p,'+
		'im2s,im3s,im1p,im2p,im3p'
	).split(',')
	const formEndsFut=(e)=>`${e}|é,${e}|ás,${e}|á,${e}|emos,${e}|éis,${e}|án,`
	const formEndsPretEir='í,iste,ió,imos,isteis,ieron,'
	const formEndsImpEir='í|a,í|as,í|a,í|amos,í|ais,í|an,'
	const formEnds={
	ar:(
		'ar,ando,ado,'+
		'o,as,a,amos,áis,an,'+
		'é,aste,ó,amos,asteis,aron,'+
		'ab|a,ab|as,ab|a,áb|amos,ab|ais,ab|an,'+
		formEndsFut('ar')+
		'a,e,emos,ad,en'
	).split(','),
	er:(
		'er,iendo,ido,'+
		'o,es,e,emos,éis,en,'+
		formEndsPretEir+
		formEndsImpEir+
		formEndsFut('er')+
		'e,a,amos,ed,an'
	).split(','),
	ir:(
		'ir,iendo,ido,'+
		'o,es,e,imos,ís,en,'+
		formEndsPretEir+
		formEndsImpEir+
		formEndsFut('ir')+
		'e,a,amos,id,an'
	).split(','),
	}
	const a=formEnds[infEnd]
	return formIds.reduce((o,k,i)=>({...o,[k]:stem+'|'+a[i]}),{})
}
const v2formIds=(pattern)=>{
	const [base,person,number]=pattern.split(/(.)(.)$/)
	function* subEnd(person,number) {
		yield base+person+number
	}
	function* subPerson(number) {
		if (person=='*') {
			for (let p of '123') yield* subEnd(p,number)
		} else {
			yield* subEnd(person,number)
		}
	}
	function* subNumber() {
		if (number=='*') {
			for (let n of 'sp') yield* subPerson(n)
		} else {
			yield* subPerson(number)
		}
	}
	return Array.from(subNumber())
}
const v2repl=(pattern,replacement)=>{
	const a=replacement.split(',')
	return v2formIds(pattern).reduce((o,k,i)=>({...o,[k]:a[i]}),{})
}
const v2replIm=(replacement)=>{
	const a=replacement.split(',')
	return 'im2s,im3s,im1p,im2p,im3p'.split(',').reduce((o,k,i)=>({...o,[k]:a[i]}),{})
}
const v2vowel=(oldVowel,newVowel,dict)=>{ // TODO make note: https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Verbos_con_alternancia_voc%C3%A1lica
	const result={...dict}
	for (const formId of ['pres1s','pres2s','pres3s','pres3p','im2s','im3s','im3p']) {
		const [oldStem,end]=result[formId].split('|')
		const i=oldStem.lastIndexOf(oldVowel)
		const newStem=oldStem.slice(0,i)+newVowel+oldStem.slice(i+oldVowel.length)
		result[formId]=newStem+'|'+end
	}
	return result
}
const v2yoHandler=(dict,replacementFn,note)=>{
	const result={...dict}
	for (const formId of ['pres1s','im3s','im1p','im3p']) {
		result[formId]=[replacementFn(result[formId]),note]
	}
	return result
}
const v2yo=(stem,dict)=>v2yoHandler(dict,s=>s.replace(/^.*?\|/,stem+'|'))
const v2yojo=(dict)=>v2yoHandler(dict,s=>s.replace(/.\|/,'[j]|'),'у -ger и -gir-глаголов для yo в настоящем времени -g- в корне меняется на -j-')
const v2yendo=(dict)=>{
	const result={...dict}
	for (const formId of ['ger','pret3s','pret3p']) {
		result[formId]=result[formId].replace(/\|i/,'|[y]')
	}
	for (const formId of ['par','pret2s','pret1p','pret2p']) {
		result[formId]=result[formId].replace(/\|i/,'|[í]')
	}
	result['ger']=[result['ger'],'после гласной -iendo меняется на -yendo']
	return result
}
const v2pret=(strongStem,dict)=>{ // TODO make note: https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Pret%C3%A9ritos_fuertes
	const result={...dict}
	const ends='e,iste,o,imos,isteis,ieron'.split(',')
	const markEnds='[e],[i]ste,[o],[i]mos,[i]steis,[ie]ron'.split(',')
	for (const [i,formId] of v2formIds('pret**').entries()) {
		const [stem,end]=result[formId].split('|')
		const strongEnd=(end==ends[i]) ? end : markEnds[i]
		result[formId]=strongStem+'|'+strongEnd
	}
	return result
}
const v2pretYoZar=(dict)=>{
	const result={...dict}
	for (const formId of ['pret1s','im3s','im1p','im3p']) {
		result[formId]=[result[formId].replace(/z\|/,'[c]|'),'у -zar-глаголов -ze меняется на -ce']
	}
	return result
}
const v2imp=(stem,dict)=>{
	const result={...dict}
	for (const formId of v2formIds('imp**')) {
		result[formId]=result[formId].replace(/^.*?\|/,`${stem}|`)
	}
	return result
}
const v2fut=(stem,dict)=>{
	const result={...dict}
	for (const formId of v2formIds('fut**')) {
		result[formId]=result[formId].replace(/^.*\|.*\|/,`${stem}|[]r|`)
	}
	return result
}
const verbs=[
	// regular
	['hablar',v2('hablar'),'говорить'],
	['comer',v2('comer'),'есть'],
	['vivir',v2('vivir'),'жить'],
	// helper
	['estar',{...v2pret('est[uv]',v2('estar')),
		...v2repl('pres*s','est|o[y],est|[á]s,est|[á]'),
		pres3p:'est|[á]n',
		im2s:'est|[á]',im3s:'est|[é]',im3p:'est|[é]n',
	},['быть','быть временно, быть в указанном месте']],
	['ser',{...v2('ser'),
		...v2repl('pres**','s|o[y],[er]|es,[es]|[],s|[o]mos,s|[o]is,s|[o]n'),
		...v2repl('pret**','[fu]|[i],[fu]|iste,[fu]|[e],[fu]|imos,[fu]|isteis,[fu]|[]eron'),
		...v2repl('imp**','[er]|[]|a,[er]|[]|as,[er]|[]|a,[ér]|[]|amos,[er]|[]|ais,[er]|[]|an'),
		...v2replIm('s|[é],s[e]|a,s[e]|amos,s|ed,s[e]|an'),
	},['быть','быть постоянно, быть в указанный момент времени']],
	['ir',{...v2('ir'),
		ger:'|[y]endo',
		...v2repl('pres**','[v]|o[y],[v]|as,[v]|a,[v]|amos,[v]|[a]is,[v]|an'),
		...v2repl('pret**','[fu]|[i],[fu]|iste,[fu]|[e],[fu]|imos,[fu]|isteis,[fu]|[]eron'),
		...v2repl('imp**','[ib]|[]|a,[ib]|[]|as,[ib]|[]|a,[íb]|[]|amos,[ib]|[]|ais,[ib]|[]|an'),
		...v2replIm('[v]|e,[vay]|a,[vay]|amos,|id,[vay]|an'),
	},'идти'],
	// TODO haber
	// single vowel change
	['pensar',v2vowel('e','[i]e',v2('pensar')),'думать'],
	// rest
	['dar',{...v2pret('d',v2('dar')), // легче посчитать за сильный претерит, хотя викисловарь так не считает
		pres1s:'d|o[y]',
		pres2p:'d|[a]is',
		pret1s:'d|[i]',
		pret3s:'d|[io]',
		im3s:'d|[é]',
	},'давать'],
	['leer',v2yendo(v2('leer')),'читать'],
	['ver',{...v2imp('v[e]',v2yo('v[e]',v2('ver'))),
		par:'v|i[st]o',
		pres2p:'v|[e]is',
		pret1s:'v|[i]',
		pret3s:'v|i[o]',
	},'видеть'],
	['venir',{...v2fut('ven[d]',v2pret('v[i]n',v2yo('ven[g]',v2vowel('e','[i]e',v2('venir'))))),
		ger:'v[i]n|iendo',
		im2s:'ven|[]',
	},'приходить'],
	['hacer',v1(
		'hac|er,hac|iendo,h[e]|[ch]o',
		v1pres('hacer','ha[g]|o'),
		'h[i]c|[e],h[i]c|iste,h[iz]|[o],h[i]c|imos,h[i]c|isteis,h[i]c|ieron',
		v1imp('hacer'),
		'ha[z]|[],ha[g]|a,ha[g]|amos,hac|ed,ha[g]|an',
	),'делать'],
	['poner',{...v2fut('pon[d]',v2pret('p[us]',v2yo('pon[g]',v2('poner')))),
		par:'p[ues]|[t]o',
		im2s:'pon|[]',
	},'ставить'],
	['poner',v1(
		'pon|er,pon|iendo,pu[e]s#[t]o',
		v1pres('poner','pon[g]|o'),
		'pus#[e],pus#iste,pus#[o],pus#imos,pus#isteis,pus#ieron',
		v1imp('poner'),
		'pon|[],pon[g]|a,pon[g]|amos,pon|ed,pon[g]|an',
	),'ставить'],
	['tener',v1(
		'ten|er,ten|iendo,ten|ido',
		'ten[g]|o,t[i]en|es,t[i]en|e,ten|emos,ten|éis,t[i]en|en',
		'tuv#[e],tuv#iste,tuv#[o],tuv#imos,tuv#isteis,tuv#ieron',
		v1imp('tener'),
		'ten|[],ten[g]|a,ten[g]|amos,ten|ed,ten[g]|an',
	),'иметь'],
	['saber',v1(
		'sab|er,sab|iendo,sab|ido',
		v1pres('saber','s#[é]'),
		'sup#[e],sup#iste,sup#[o],sup#imos,sup#isteis,sup#ieron',
		v1imp('saber'),
		'sab|e,sep#a,sep#amos,sab|ed,sep#an',
	),['знать','знать факт/навык']],
	['conocer',v2yo('cono[z]c',v2('conocer')),['знать','знать человека/место']],
	['traer',{...v2pret('tra[j]',v2yo('tra[ig]',v2('traer'))),
		pret3p:'traj|[]eron',
	},'приносить'],
	['coger',v2yojo(v2('coger')),'брать'],
	['elegir',v1(
		'eleg|ir,el[i]g|iendo,ele[c]|[t]o',
		v1jo('el[i]gir'),'el[i]g|es,el[i]g|e,eleg|imos,eleg|ís,el[i]g|en',
		'eleg|í,eleg|iste,el[i]g|ió,eleg|imos,eleg|isteis,el[i]g|ieron',
		v1imp('elegir'),
		'el[i]g|e,el[ij]|a,el[ij]|amos,eleg|id,el[ij]|an',
	),'выбирать'],
	['seguir',v1(
		'segu|ir',['s[i]gu|iendo','-yendo нет, хотя -iendo предшествует гласная'],'segu|ido',
		's[i]g[]|o,s[i]gu|es,s[i]gu|e,segu|imos,segu|ís,s[i]gu|en',
		'segu|í,segu|iste,s[i]gu|ió,segu|imos,segu|isteis,s[i]gu|ieron',
		v1imp('seguir'),
		's[i]gu|e,s[i]g[]|a,s[i]g[]|amos,segu|id,s[i]g[]|an',
	),'следовать'],
	['poder',v1(
		'pod|er,p[u]d|iendo,pod|ido',
		'p[ue]d|o,p[ue]d|es,p[ue]d|e,pod|emos,pod|éis,p[ue]d|en',
		'p[u]d|[e],p[u]d|iste,p[u]d|[o],p[u]d|imos,p[u]d|isteis,p[u]d|ieron',
		v1imp('poder'),
		'p[ue]d|e,p[ue]d|a,pod|amos,pod|ed,p[ue]d|an',
	),'мочь'],
	['empezar',v2pretYoZar(v2vowel('e','[i]e',v2('empezar'))),'начинать'],
	['tocar',v1(
		'toc|ar,toc|ando,toc|ado',
		v1pres('tocar'),
		['to[qu]|é','у -car-глаголов -cé меняется на -qué'],'toc|aste,toc|ó,toc|amos,toc|asteis,toc|aron',
		v1imp('tocar'),
		'toc|a,to[qu]|e,to[qu]|emos,toc|ad,to[qu]|en',
	),'трогать'],
]

const readPair=(a)=>Array.isArray(a)?a:[a,'']

function createTable($container,sortType) {
	while ($container.firstChild) $container.removeChild($container.firstChild)
	const $table=document.createElement('table')
	$table.setAttribute('lang','es')
	const $thead=document.createElement('thead')
	$table.appendChild($thead)
	$thead.insertRow().innerHTML="<th colspan=2><th><abbr title='Primera conjugación'>1ª conj.</abbr><th><abbr title='Segunda conjugación'>2ª conj.</abbr><th><abbr title='Tercera conjugación'>3ª conj.</abbr>"
	for (let [formGroupId,formGroupMembers] of verbFormOrder) {
		const $tbody=document.createElement('tbody')
		$table.appendChild($tbody)
		let firstInGroup=true
		if (!formGroupMembers) {
			formGroupMembers=[]
			if (sortType!='number') {
				for (const p of [1,2,3]) {
					for (const n of ['s','p']) {
						if (verbForms[formGroupId+p+n]) formGroupMembers.push(formGroupId+p+n)
					}
				}
			} else {
				for (const n of ['s','p']) {
					for (const p of [1,2,3]) {
						if (verbForms[formGroupId+p+n]) formGroupMembers.push(formGroupId+p+n)
					}
				}
			}
		}
		for (formId of formGroupMembers) {
			const $row=$tbody.insertRow()
			const formPreNumber=formId.slice(0,-1)
			const formNumber=formId.slice(-1)
			let compactRow=false
			if (sortType=='person-compact' && formPreNumber in compactableVerbForms) {
				compactRow=true
				if (formId==formPreNumber+'p') continue
			}
			if (!compactRow && sortType!='number' && (formNumber=='s' || formNumber=='p')) {
				$row.classList.add('number-'+formNumber)
			}
			if (firstInGroup && formGroupId) {
				const [formGroupName]=verbFormGroups[formGroupId]
				$row.insertAdjacentHTML('beforeend',`<th class=group rowspan=${formGroupMembers.length}><span>${formGroupName}</span>`)
			}
			firstInGroup=false
			let [formText,formNote]=verbForms[formId]
			if (compactRow) {
				[formText,formNote]=compactableVerbForms[formPreNumber]
			}
			const $formCell=document.createElement('th')
			if (!formGroupId) $formCell.setAttribute('colspan',2)
			$row.appendChild($formCell)
			$formCell.innerHTML=formText
			$formCell.setAttribute('title',formNote)
			const getFormHtml=(form)=>{
				let variant=1
				let [stem,end,subend]=form.split('|')
				if (end===undefined) {
					variant=2
					;[stem,end,subend]=form.split('#')
				}
				const mark=(s)=>s.replace(/\[(.*?)\]/g,'<strong>$1</strong>')
				const makeSpan=(cls,s)=>s?`<span class=${cls}-${variant}>${mark(s)}</span>`:''
				let t=makeSpan('stem',stem)+makeSpan('end',end)
				if (subend!==undefined) t+=makeSpan('subend',subend)
				return t
			}
			for (const [verb,forms] of verbs) {
				const [form,formNote]=readPair(forms[formId])
				const $cell=$row.insertCell()
				if (!forms[formId]) continue
				if (compactRow) {
					const [form2]=readPair(forms[formPreNumber+'p'])
					if (form2.startsWith(form)) {
						$cell.innerHTML=getFormHtml(`${form}<em>${form2.slice(form.length)}</em>`)
					} else {
						$cell.innerHTML=getFormHtml(form)+" / "+getFormHtml(form2)
					}
				} else {
					$cell.innerHTML=getFormHtml(form)
					if (formNote) $cell.setAttribute('title',formNote)
				}
			}
		}
	}
	{
		const $tbody=document.createElement('tbody')
		$table.appendChild($tbody)
		{
			const $row=$tbody.insertRow()
			$row.setAttribute('lang','ru')
			const $cell=document.createElement('th')
			$cell.setAttribute('colspan',2)
			$row.appendChild($cell)
			for (const [verb,forms,translationData] of verbs) {
				const [translation,translationNote]=readPair(translationData)
				const $cell=$row.insertCell()
				$cell.innerHTML=translation
				if (translationNote) $cell.setAttribute('title',translationNote)
			}
		}
		{
			const $row=$tbody.insertRow()
			const $cell=document.createElement('th')
			$cell.setAttribute('colspan',2)
			$row.appendChild($cell)
			for (const [verb] of verbs) {
				$row.insertCell().innerHTML="<a href=https://es.wiktionary.org/wiki/"+verb+"#Conjugaci%C3%B3n>[w]</a>"
			}
		}
	}
	$container.appendChild($table)
}

function createTableAndOptions() {
	const sort=localStorage.getItem('glaconjurer-sort') || 'number';
	const $body=document.getElementsByTagName('body')[0]
	const $tableContainer=document.createElement('div')
	createTable($tableContainer,sort)
	$body.appendChild($tableContainer)
	const $optionsContainer=document.createElement('details')
	$optionsContainer.innerHTML="<summary>Настройки</summary>"
	const $groupingControls=document.createElement('div')
	$groupingControls.innerHTML=[
		['number','Обычный порядок'],
		['person','Группировка по лицам'],
		['person-compact','...с уплотнением'],
	].map(([id,text])=>`<label><input type=radio name=sort value=${id+(sort==id?' checked':'')}> ${text}</label>`).join('')
	$groupingControls.addEventListener('change',(ev)=>{
		localStorage.setItem('glaconjurer-sort',ev.target.value)
		createTable($tableContainer,ev.target.value)
	})
	$optionsContainer.appendChild($groupingControls)
	const $gameControls=document.createElement('div')
	const $gameButton=document.createElement('button')
	$gameButton.innerHTML="Играть"
	$gameButton.addEventListener('click',(ev)=>{
		$body.removeChild($tableContainer)
		$body.removeChild($optionsContainer)
		createGame()
	})
	$gameControls.appendChild($gameButton)
	$optionsContainer.appendChild($gameControls)
	$body.appendChild($optionsContainer)
}

function createGame() {
	const gameVerbs=[]
	for (const [verb,forms] of verbs) {
		for (formId in forms) {
			if (formId=='inf') continue
			const [form]=readPair(forms[formId])
			gameVerbs.push([verb,formId,form.replace(/[|#[\]]/g,'')])
		}
	}
	const shuffle=(a)=>{
		let i=a.length
		while (i>0) {
			let j=Math.floor(Math.random()*i)
			i-=1
			;[a[i],a[j]]=[a[j],a[i]]
		}
	}
	shuffle(gameVerbs)
	let iCurrentGameVerb=0
	const $body=document.getElementsByTagName('body')[0]
	const $gameContainer=document.createElement('div')
	const $table=document.createElement('table')
	$gameContainer.appendChild($table)
	const $buttonControls=document.createElement('div')
	const $checkButton=document.createElement('button')
	$checkButton.innerHTML='Завершить'
	$checkButton.addEventListener('click',(ev)=>{
		$body.removeChild($gameContainer)
		createTableAndOptions()
	})
	$buttonControls.appendChild($checkButton)
	$gameContainer.appendChild($buttonControls)
	$body.appendChild($gameContainer)
	const createNextQuestion=()=>{
		if (iCurrentGameVerb>=gameVerbs.length) return
		const [verb,formId,form]=gameVerbs[iCurrentGameVerb]
		const $tbody=document.createElement('tbody')
		$table.appendChild($tbody)
		const $infRow=$tbody.insertRow()
		$infRow.insertAdjacentHTML('beforeend',"<th colspan=2>")
		$infRow.insertCell().innerHTML=verb
		const $formRow=$tbody.insertRow()
		const [formGroupId,n,p]=formId.split(/(\d)/)
		if (n) {
			const [_,formGroupTitle]=verbFormGroups[formGroupId]
			const [formTitle]=verbForms[formId]
			$formRow.insertAdjacentHTML('beforeend',`<th>${formGroupTitle},<th>${formTitle}`)
		} else {
			const [formTitle]=verbForms[formId]
			$formRow.insertAdjacentHTML('beforeend',`<th colspan=2>${formTitle}`)
		}
		const $formInputTd=$formRow.insertCell()
		const $formInput=document.createElement('input')
		$formInputTd.appendChild($formInput)
		const $formButtonTd=$formRow.insertCell()
		const $formButton=document.createElement('button')
		$formButton.innerHTML='Проверить'
		$formButtonTd.appendChild($formButton)
		$formButton.addEventListener('click',(ev)=>{
			const userForm=$formInput.value
			$formInputTd.removeChild($formInput)
			$formButtonTd.removeChild($formButton)
			$formInputTd.insertAdjacentText('beforeend',userForm)
			if (userForm==form) {
				$formButtonTd.insertAdjacentHTML('beforeend',"<span class=correct>Правильно</span>")
			} else {
				$formButtonTd.insertAdjacentHTML('beforeend',"<span class=incorrect>Неправильно</span>")
				$tbody.insertRow().innerHTML=`<th colspan=2>Правильный ответ<td>${form}`
			}
			iCurrentGameVerb++
			createNextQuestion()
		})
	}
	createNextQuestion()
}

createTableAndOptions()

</script>
</body>
</html>
