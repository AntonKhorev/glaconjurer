<!DOCTYPE html>
<html lang=ru>
<head>
<meta charset=utf-8>
<meta name=viewport content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'>
<style>
body {
	margin: 0;
	font-family: sans-serif;
	background: white;
	color: black;
}
#options .opener {
	position: fixed;
	top: 0;
	left: 0;
	background: white;
}
#options .opener button,
#options .closer button {
	font-size: 2em;
	height: 2.8rem;
	width: 2.8rem;
	padding: 0;
	line-height: 100%;
	vertical-align: middle;
}
#options .dialog {
	display: none;
	position: fixed;
	overflow: auto;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: white;
}
#options .dialog.open {
	display: block;
}
#options .block {
	max-width: 30em;
	margin: 2em auto;
}
#options .block.forms {
	display: none;
}
#options .block.forms.open {
	display: block;
}
.conjtable table {
	border-collapse: collapse;
}
.conjtable tbody {
	border-top: solid 1px gray;
}
.conjtable td,
.conjtable th {
	text-align: left;
	font-weight: normal;
}
.conjtable th {
	padding: .2rem;
}
.conjtable td {
	padding: 0 .2rem;
	white-space: nowrap;
}
.conjtable thead th {
	position: sticky;
	top: 0;
	background: white;
}
.conjtable thead tr:nth-child(2) th {
	top: 1.6rem;
}
.conjtable tbody th.group {
	position: sticky;
	left: 0;
	width: 1rem;
}
.conjtable tbody th.group span {
	width: 1rem;
	writing-mode: vertical-rl;
	transform: rotate(180deg);
}
.conjtable tbody th.spangroup {
	position: sticky;
	left: 0;
	/*min-width: 5.1rem;*/
}
.conjtable tbody th.subgroup {
	position: sticky;
	left: 1.4rem;
	/*min-width: 3.7rem;*/
}
.conjtable tbody th.widegroup span {
	position: sticky;
	left: .2rem;
}
.conjtable tr.compare {
	opacity: 0.7;
}
.conjtable tr.join-below td span,
.conjtable tr.join-below th {
	padding-bottom: 0;
}
.conjtable tr.join-above td span,
.conjtable tr.join-above th {
	padding-top: 0;
}
.conjtable td[title],
.conjtable th[title] {
	background: linear-gradient(135deg, #484 .3rem, transparent .3rem), white;
}
.conjtable th.long {
	letter-spacing: -0.07rem;
}
.conjtable th.very-long {
	letter-spacing: -0.07rem;
	font-size: 0.8rem;
}
.conjtable .stem {
	display: inline-block;
	border-right: solid 1px #060;
	padding: .2rem .05rem .2rem 0;
}
.conjtable .stem + .end {
	border: none;
}
.conjtable .end {
	display: inline-block;
	font-weight: bold;
	border-left: solid 1px #060;
	padding: .2rem 0 .2rem .05rem;
}
.conjtable .subend {
	display: inline-block;
	color: #333;
	font-weight: bold;
	border-left: solid 1px #DDD;
	padding: .2rem 0 .2rem .05rem;
}
.conjtable strong {
	font-weight: normal;
	color: #608;
}
.conjtable strong.insert {
	color: #A00;
}
.conjtable .end strong {
	font-weight: bold;
}
.conjtable .stem strong:empty,
.conjtable .end strong:empty {
	display: inline-block;
	width: .5ex;
	border-bottom: solid 1px #A00;
}
.conjtable th em,
.conjtable .end em,
.conjtable .subend em {
	font-style: normal;
	color: green;
}
.conjtable .combination em {
	animation: 1s 2 alternate blink;
}
@keyframes blink {
	from {
		opacity: 1;
	}
	to {
		opacity: 0.1;
	}
}
</style>
</head>
<body>
<script>
class Verb {
	constructor(title,translation) {
		this.title=title
		if (typeof translation == 'string' || Array.isArray(translation)) {
			translation={ru:translation}
		}
		this.translation=translation
	}
	replace(forms) {
		for (const [k,v] of Object.entries(forms)) {
			const formIds=this.formIdsFromPattern(k)
			let replacements=[]
			if (v!==undefined) replacements=v.split(',')
			for (const [i,formId] of formIds.entries()) {
				this.forms[formId]=replacements[i]
			}
		}
		return this
	}
	listForms() {
		return []
	}
	getForm(formId) {
		return undefined
	}
	getRawForm(formId) {
		return this.getForm(formId).replace(/[|{}[\]]/g,'')
	}
	getFormNote(formId) {
		return undefined
	}
	formIdsFromPattern(pattern) {
		const [base,person,number]=pattern.split(/(.)(.)$/)
		function* subEnd(person,number) {
			yield base+person+number
		}
		function* subPerson(number) {
			if (person=='_') {
				for (let p of '123') yield* subEnd(p,number)
			} else {
				yield* subEnd(person,number)
			}
		}
		function* subNumber() {
			if (number=='_') {
				for (let n of 'sp') yield* subPerson(n)
			} else {
				yield* subPerson(number)
			}
		}
		return Array.from(subNumber())
	}
}

// wiktionary templates:
// https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Plantillas_de_flexi%C3%B3n_de_verbos
// https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Plantillas_auxiliares_de_flexi%C3%B3n
class SpanishVerb extends Verb {
	constructor(title,translation) {
		super(title,translation)
		this.forms={}
		this.formNotes={}
		;[this.stem,this.them]=title.split(/(.).$/)
		if (this.them=='í') this.them='i'
		const formIds=(
			'inf,ger,par,'+
			'pres1s,pres2s,pres3s,pres1p,pres2p,pres3p,'+
			'pret1s,pret2s,pret3s,pret1p,pret2p,pret3p,'+
			'imp1s,imp2s,imp3s,imp1p,imp2p,imp3p,'+
			'fut1s,fut2s,fut3s,fut1p,fut2p,fut3p,'+
			'cond1s,cond2s,cond3s,cond1p,cond2p,cond3p,'+
			'subj1s,subj2s,subj3s,subj1p,subj2p,subj3p,'+
			'im2s,im3s,im1p,im2p,im3p'
		).split(',')
		const formEndsFut=(e)=>`${e}|é,${e}|ás,${e}|á,${e}|emos,${e}|éis,${e}|án,`
		const formEndsCond=(e)=>`${e}|ía,${e}|ías,${e}|ía,${e}|íamos,${e}|íais,${e}|ían,`
		const formEndsPretEir='í,iste,ió,imos,isteis,ieron,'
		const formEndsImpEir='í|a,í|as,í|a,í|amos,í|ais,í|an,'
		const formEnds={
		a:(
			'ar,ando,ado,'+
			'o,as,a,amos,áis,an,'+
			'é,aste,ó,amos,asteis,aron,'+
			'ab|a,ab|as,ab|a,áb|amos,ab|ais,ab|an,'+
			formEndsFut('ar')+
			formEndsCond('ar')+
			'e,es,e,emos,éis,en,'+
			'a,e,emos,ad,en'
		).split(','),
		e:(
			'er,iendo,ido,'+
			'o,es,e,emos,éis,en,'+
			formEndsPretEir+
			formEndsImpEir+
			formEndsFut('er')+
			formEndsCond('er')+
			'a,as,a,amos,áis,an,'+
			'e,a,amos,ed,an'
		).split(','),
		i:(
			'ir,iendo,ido,'+
			'o,es,e,imos,ís,en,'+
			formEndsPretEir+
			formEndsImpEir+
			formEndsFut('ir')+
			formEndsCond('ir')+
			'a,as,a,amos,áis,an,'+
			'e,a,amos,id,an'
		).split(','),
		}[this.them]
		for (const [i,formId] of formIds.entries()) {
			let stem=this.stem
			let end=formEnds[i]
			const replace=(replacements,endPattern)=>{
				const stemMatch=stem.match(new RegExp('(?:'+Object.keys(replacements).join('|')+')$'))
				const endMatch=end.match(endPattern)
				if (stemMatch && endMatch) {
					const [s]=stemMatch
					const [e]=endMatch
					const r=replacements[s]
					stem=stem.replace(new RegExp(s+'$'),r.length==s.length?'['+r+']':'{'+r+'}')
					this.formNotes[formId]=`у -${s}${this.them}r-глаголов -${s}${e}- меняется на -${r}${e}-`
				}
			}
			if (this.them=='a') { // https://es.wiktionary.org/wiki/Plantilla:mutacion.es.nexo.aou
				replace({c:'qu',z:'c',gu:'gü',g:'gu'},/^[eéií]/)
			} else if (this.them=='e' || this.them=='i') { // https://es.wiktionary.org/wiki/Plantilla:mutacion.es.nexo.ei
				replace({qu:'c',c:'z',g:'j',gu:'g','gü':'gu'},/^[aáoó]/)
			}
			this.forms[formId]=stem+'|'+end
		}
	}
	get wiktionary() {
		return "<a href=https://es.wiktionary.org/wiki/"+this.title+"#Conjugaci%C3%B3n>[w]</a>"
	}
	listForms() {
		return Object.keys(this.forms)
	}
	getForm(formId) {
		if (formId.match(/^imp(?:ra|se)[123][sp]$/)) {
			let stem=this.forms.pret3p.slice(0,-3)
			if (formId=='impra1p' || formId=='impse1p') {
				stem=stem.replace(/[ae](?=[\[\]{}]*$)/,x=>{
					if (x=='a') {
						return 'á'
					} else if (x=='e') {
						return 'é'
					} else {
						return x
					}
				})
			}
			return stem+'|'+{
				impra1s:'ra',
				impra2s:'ras',
				impra3s:'ra',
				impra1p:'ramos', // TODO add stress
				impra2p:'rais',
				impra3p:'ran',
				impse1s:'se',
				impse2s:'ses',
				impse3s:'se',
				impse1p:'semos', // TODO add stress
				impse2p:'seis',
				impse3p:'sen',
			}[formId]
		}
		return this.forms[formId]
	}
	getFormNote(formId) {
		return this.formNotes[formId]
	}
	replaceLastStemVowel(formId,v) {
		let replacement='['+v+']'
		if (v.length>1) replacement='{'+v+'}'
		const [oldStem,end]=this.forms[formId].split(/\|(.*)/)
		let i=oldStem.length-1
		for (;i>=0;i--) {
			if ('aeio'.includes(oldStem[i]) || oldStem[i]=='u' && oldStem[i-1]!='g') break
		}
		const newStem=oldStem.slice(0,i)+replacement+oldStem.slice(i+1)
		this.forms[formId]=newStem+'|'+end
	}
	vowel(v,va) {
		for (const formId of [ // https://es.wiktionary.org/wiki/Plantilla:es.v.conj.-ie-ue-.er , https://es.wiktionary.org/wiki/Plantilla:es.v.conj.-ie-ue-.ar , https://es.wiktionary.org/wiki/Plantilla:es.v.conj.2.ar
			'pres1s','pres2s','pres3s','pres3p',
			'subj1s','subj2s','subj3s','subj3p',
			'im2s','im3s','im3p'
		]) {
			this.replaceLastStemVowel(formId,v)
		}
		if (va===undefined) return this
		for (const formId of ['ger','pret3s','pret3p','subj1p','subj2p','im1p']) { // https://es.wiktionary.org/wiki/Plantilla:es.v.conj.-ie-i-ue-u-.ir
			this.replaceLastStemVowel(formId,va)
		}
		return this
	}
	yo(stem) {
		for (const formId of ['pres1s','subj1s','subj2s','subj3s','subj1p','subj2p','subj3p','im3s','im1p','im3p']) {
			this.forms[formId]=this.forms[formId].replace(/^.*?\|/,stem+'|')
			delete this.formNotes[formId]
		}
		return this
	}
	yendo() {
		for (const formId of ['ger','pret3s','pret3p']) {
			this.forms[formId]=this.forms[formId].replace(/\|i/,'|[y]')
		}
		for (const formId of ['par','pret2s','pret1p','pret2p']) {
			//this.forms[formId]=this.forms[formId].replace(/\|i/,'|[í]')
			//this.forms[formId]=this.forms[formId].replace(/(?<=[^u]\|)i/,'[í]') // https://bugzilla.mozilla.org/show_bug.cgi?id=1225665
			this.forms[formId]=this.forms[formId].replace(/(.)\|i/,(match,p1)=>{
				if (p1=='u') {
					return p1+'|i'
				} else {
					return p1+'|[í]'
				}
			})
		}
		this.formNotes.ger='после гласной -iendo меняется на -yendo'
		return this
	}
	pret(strongStem) { // TODO make note: https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Pret%C3%A9ritos_fuertes
		const ends='e,iste,o,imos,isteis,ieron'.split(',')
		const markEnds      ='[e],[i]ste,[o],[i]mos,[i]steis,[ie]ron'.split(',')
		const markInsertEnds='{e},{i}ste,{o},{i}mos,{i}steis,{ie}ron'.split(',')
		for (const [i,formId] of this.formIdsFromPattern('pret__').entries()) {
			const [,end]=this.forms[formId].split('|')
			let strongEnd=end
			if (strongStem.replace(/[|{}[\]]/g,'').slice(-1)=='j' && ends[i]=='ieron') {
				strongEnd='{}eron'
			} else if (end!=ends[i]) {
				if (end.length==ends[i].length) {
					strongEnd=markEnds[i]
				} else {
					strongEnd=markInsertEnds[i]
				}
			}
			this.forms[formId]=strongStem+'|'+strongEnd
		}
		return this
	}
	imp(stem) {
		for (const formId of this.formIdsFromPattern('imp__')) {
			this.forms[formId]=this.forms[formId].replace(/^.*?\|/,`${stem}|`)
		}
		return this
	}
	fut(stem) {
		for (const formId of [...this.formIdsFromPattern('fut__'),...this.formIdsFromPattern('cond__')]) {
			this.forms[formId]=this.forms[formId].replace(/^.*\|.*\|/,`${stem}|{}r|`)
		}
		return this
	}
}

class Language {
	constructor() {
		this.verbs={}
		for (const item of this.provideTopicVerbs()) {
			if (!Array.isArray(item)) this.verbs[item.title]=item
		}
	}
	getVerbFormTitle(formId) {
		//return ['','']
		return undefined
	}
	hasVerbForm(formId) {
		return this.getVerbFormTitle(formId)
	}
	isVerbFormCompactible(formId) {
		return false
	}
	getVerbs() {
		return {}
	}
	listPersonalVerbForms() {
		return []
	}
	listSelectableVerbForms() {
		return this.listPersonalVerbForms()
	}
	getVerbFormOrder(sortType,formSet,compareLanguages) { // TODO this is table representation stuff now, shouldn't be in this class
		const a=[] // [formGroupId, [[verbLanguage,joinAbove,joinBelow,formId,[verbFormId,...]], ...]], ...
		const pushUncomparedRowJoint=(formGroupRows,unfilteredFormIds)=>{
			let formIds=unfilteredFormIds.filter(formId=>this.hasVerbForm(formId))
			for (let i=0;i<formIds.length;i++) {
				formGroupRows.push([this,i>0,i<formIds.length-1,formIds[i],[formIds[i]]])
			}
		}
		const pushComparedRowJoint=(formGroupRows,formId)=>{
			if (!this.hasVerbForm(formId)) return
			let languageList=[this]
			if (sortType=='number-compare') languageList=[this,...compareLanguages.filter(lang=>lang.hasVerbForm(formId))]
			for (let i=0;i<languageList.length;i++) {
				formGroupRows.push([languageList[i],i>0,i<languageList.length-1,formId,[formId]])
			}
		}
		{
			const formGroupId='nonpers'
			const formGroupRows=[]
			const nonpersonalFormIds={inf:true}
			for (const formId of this.listSelectableVerbForms()) {
				nonpersonalFormIds[formId]=true
			}
			for (const formId of this.listPersonalVerbForms()) {
				delete nonpersonalFormIds[formId]
			}
			for (const formId in nonpersonalFormIds) {
				if (formId in formSet && !formSet[formId]) continue
				pushComparedRowJoint(formGroupRows,formId)
			}
			a.push([formGroupId,formGroupRows])
		}
		for (const formGroupId of this.listPersonalVerbForms()) {
			if (formGroupId in formSet && !formSet[formGroupId]) continue
			const formGroupRows=[]
			if (sortType=='person' || sortType=='person-compact') {
				for (const p of [1,2,3]) {
					if (sortType=='person-compact' && this.isVerbFormCompactible(formGroupId+p)) {
						formGroupRows.push([this,0,0,formGroupId+p,[formGroupId+p+'s',formGroupId+p+'p']])
						continue
					}
					pushUncomparedRowJoint(formGroupRows,['s','p'].map(n=>(formGroupId+p+n)))
				}
			} else {
				for (const n of ['s','p']) {
					if (sortType=='number-compare') {
						for (const p of [1,2,3]) {
							pushComparedRowJoint(formGroupRows,formGroupId+p+n)
						}
					} else {
						pushUncomparedRowJoint(formGroupRows,[1,2,3].map(p=>(formGroupId+p+n)))
					}
				}
			}
			a.push([formGroupId,formGroupRows])
		}
		return a
	}
	listVerbOrders() {
		return [
			['topic','по видам спряжений глаголов'],
			['frequency','по частоте употребления'],
			['alphabet','по алфавиту'],
		]
	}
	*listVerbs(orderType) {
		for (const [,...c2s] of this.getVerbOrder(orderType)) {
			for (const [,...vs] of c2s) {
				for (const v of vs) yield this.getVerbs()[v]
			}
		}
	}
	getVerbOrder(orderType) {
		if (orderType=='topic') {
			const order=[]
			let level=0
			for (const item of this.provideTopicVerbs()) {
				if (!Array.isArray(item)) {
					if (level<1) {
						order.push([''])
						level=1
					}
					const order1=order[order.length-1]
					if (level<2) {
						order1.push([''])
						level=2
					}
					const order2=order1[order1.length-1]
					order2.push(item.title)
				} else if (item[0]==2) {
					if (level<1) {
						order.push([''])
						level=1
					}
					const order1=order[order.length-1]
					order1.push([item.slice(1)])
					level=2
				} else {
					order.push([item.slice(1)])
					level=1
				}
			}
			return order
		} else if (orderType=='frequency') {
			const numbered=['по частоте употребления']
			for (const [i,v] of this.provideFrequencyVerbs().entries()) {
				numbered.push([i+1,v])
			}
			return [numbered]
		} else if (orderType=='alphabet') {
			const sorted=['по алфавиту']
			let firstLetter
			let sortedByLetter
			for (const verbId of Object.keys(this.getVerbs()).sort()) {
				if (firstLetter!=verbId[0]) {
					firstLetter=verbId[0]
					sortedByLetter=[firstLetter.toUpperCase()]
					sorted.push(sortedByLetter)
				}
				sortedByLetter.push(verbId)
			}
			return [sorted]
		} else {
			return []
		}
	}
	provideTopicVerbs() {
		return [[1,'пока не сделано']]
	}
	provideFrequencyVerbs() {
		return []
	}
}

class SpanishLanguage extends Language {
	constructor() {
		super()
		this.verbFormTitles={
			nonpers: ['','безличные формы'], // don't display group title
			inf: ['Infinitivo','инфинитив'],
			ger: ['Gerundio','для образования аналога continuous в английском по схеме спряжённый-estar + Ger. ("estoy estudiando" = "I am studying")'],
			par: ['Participio','страдательное(?) причастие прошедшего времени, меняется по родам и числам (apagado = выключенный, apagada = выключенная)'],
			pres: ['Presente','Presente'],
			pret: ['Pretérito','Pretérito indefinido'],
			imp: ['Imperfecto','Pretérito imperfecto'],
			fut: ['Futuro','Futuro'],
			cond: ['Condicional','Condicional'],
			subj: ['Subjuntivo','Presente de subjuntivo'],
			impra: ["<abbr title='Imperfecto de subjuntivo'>Imp. subj.</abbr> -ra",'Pretérito imperfecto de subjuntivo -ra'],
			impse: ["<abbr title='Imperfecto de subjuntivo'>Imp. subj.</abbr> -se",'Pretérito imperfecto de subjuntivo -se'],
			im: ['Imperativo','Imperativo'],
			im2s: ['tú','tú: ты сделай; форма глагола обычно совпадает с 3-м лицом ед. ч. Presente'],
			im3s: ['usted','usted: (вежливое) вы сделайте; форма глагола обычно совпадает императивом для tú, только окончание a меняется на e и наоборот'],
			im1p: ['nosotros','nosotros, nosotras: давайте мы сделаем'],
			im2p: ['vosotros','vosotros, vosotras: (множественное) вы сделайте'],
			im3p: ['ustedes','ustedes: (вежливое множественное) вы сделайте'],
		}
		for (const [prefix,v0,[v1s,v2s,v3sm,v3sf,v1p,v2p,v3p]] of [
			['pres','',         ['делаю','делаешь','делает','делает','делаем','делаете','делают']],
			['pret','',         ['сделал(а)','сделал(а)','сделал','сделала','сделали','сделали','сделали']],
			['fut' ,'',         ['сделаю','сделаешь','сделает','сделает','сделаем','сделаете','сделают']],
			['cond','',         ['бы сделал(а)','бы сделал(а)','бы сделал','бы сделала','бы сделали','бы сделали','бы сделали']],
			['subj','(чтобы) ', ['сделал(а)','сделал(а)','сделал','сделала','сделали','сделали','сделали']],
			['impra','(чтобы) ',['делал(а)','делал(а)','делал','делала','делали','делали','делали']],
			['impse','(чтобы) ',['делал(а)','делал(а)','делал','делала','делали','делали','делали']],
			['imp' ,'',         ['делал(а)','делал(а)','делал','делала','делали','делали','делали']],
		]) {
			this.verbFormTitles[prefix+'1s']=['yo',`yo: ${v0}я ${v1s}`]
			this.verbFormTitles[prefix+'2s']=['tú',`tú: ${v0}ты ${v2s}`]
			this.verbFormTitles[prefix+'3s']=['él',`él: ${v0}он ${v3sm}; ella: она ${v3sf}; usted: (вежливое) ${v0}вы ${v2p}`]
			this.verbFormTitles[prefix+'1p']=['nosotros',`nosotros, nosotras: ${v0}мы ${v1p}`]
			this.verbFormTitles[prefix+'2p']=['vosotros',`vosotros, vosotras: (множественное) ${v0}вы ${v2p}`]
			this.verbFormTitles[prefix+'3p']=['ellos',`ellos, ellas: ${v0}они ${v3p}; ustedes: (вежливое множественное) ${v0}вы ${v2p}`]
		}
		this.compactableVerbFormTitles={
			pres3: ['él<em>los</em>',       this.verbFormTitles.pres3s[1] +'; '+this.verbFormTitles.pres3p[1]],
			pret2: ['tú/<em>vosotros</em>', this.verbFormTitles.pret2s[1] +'; '+this.verbFormTitles.pret2p[1]],
			imp2: ['tú/<em>vosotros</em>',  this.verbFormTitles.imp2s[1]  +'; '+this.verbFormTitles.imp2p[1]],
			imp3: ['él<em>los</em>',        this.verbFormTitles.imp3s[1]  +'; '+this.verbFormTitles.imp3p[1]],
			fut3: ['él<em>los</em>',        this.verbFormTitles.fut3s[1]  +'; '+this.verbFormTitles.fut3p[1]],
			cond1: ['yo/<em>nosotros</em>', this.verbFormTitles.cond1s[1] +'; '+this.verbFormTitles.cond1p[1]],
			cond2: ['tú/<em>vosotros</em>', this.verbFormTitles.cond2s[1] +'; '+this.verbFormTitles.cond2p[1]],
			cond3: ['él<em>los</em>',       this.verbFormTitles.cond3s[1] +'; '+this.verbFormTitles.cond3p[1]],
			subj3: ['él<em>los</em>',       this.verbFormTitles.subj3s[1] +'; '+this.verbFormTitles.subj3p[1]],
			impra2: ['tú/<em>vosotros</em>',this.verbFormTitles.impra2s[1]+'; '+this.verbFormTitles.impra2p[1]],
			impra3: ['él<em>los</em>',      this.verbFormTitles.impra3s[1]+'; '+this.verbFormTitles.impra3p[1]],
			impse2: ['tú/<em>vosotros</em>',this.verbFormTitles.impse2s[1]+'; '+this.verbFormTitles.impse2p[1]],
			impse3: ['él<em>los</em>',      this.verbFormTitles.impse3s[1]+'; '+this.verbFormTitles.impse3p[1]],
			im3: ['usted<em>es</em>','usted, ustedes: (вежливое) вы сделайте'],
		}
	}
	get title() {
		return 'испанский'
	}
	get code() {
		return 'es'
	}
	getVerbFormTitle(formId) {
		return this.verbFormTitles[formId] || this.compactableVerbFormTitles[formId]
	}
	isVerbFormCompactible(formId) {
		return formId in this.compactableVerbFormTitles
	}
	getVerbs() {
		return this.verbs
	}
	listPersonalVerbForms() {
		return ['pres','pret','imp','fut','cond','subj','impra','impse','im']
	}
	listSelectableVerbForms() {
		return ['ger','par',...this.listPersonalVerbForms()]
	}
	provideTopicVerbs() {
		const v3=(...args)=>(new SpanishVerb(...args))
		return [
		[1,'правильные'],
		[2,'1ª <abbr title=conjugación>conj.</abbr>','Primera conjugación, правильный -ar-глагол'],
			v3('pasar'),
		[2,'2ª <abbr title=conjugación>conj.</abbr>','Segunda conjugación, правильный -er-глагол'],
			v3('deber'),
		[2,'3ª <abbr title=conjugación>conj.</abbr>','Tercera conjugación, правильный -ir-глагол'],
			v3('vivir'),
		[1,'орфографические изменения'],
		[2,'c→<strong class=insert>qu</strong>'],
			v3('buscar','искать'),
		[2,'z→<strong>c</strong>'],
			v3('utilizar','использовать'),
		[2,'g→<strong class=insert>gu</strong>'],
			v3('llegar','прибывать'),
		[2,'g→<strong>j</strong>'],
			v3('coger','брать'),
		[2,'gu→<strong class=insert>g</strong>'],
			v3('distinguir','различать'),
		[1,'изменения гласных'], // https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Verbos_con_alternancia_voc%C3%A1lica
		[2,'e→<strong class=insert>ie</strong>'],
			v3('pensar','думать').vowel('ie'),
		[2,'e→<strong class=insert>ie</strong>,<strong>i</strong>'],
			v3('sentir').vowel('ie','i'),
		[2,'e→<strong>i</strong>'],
			v3('pedir','просить').vowel('i','i'),
		[2,'o→<strong class=insert>ue</strong>'],
			v3('contar','считать').vowel('ue'),
		[2,'o→<strong class=insert>ue</strong>,<strong>u</strong>'],
			v3('dormir','спать').vowel('ue','u'),
		[2,'u→<strong class=insert>ue</strong>'],
			v3('jugar').vowel('ue'),
		[2,'i→<strong>í</strong>'],
			v3('enviar','посылать').vowel('í'),
		[1,'изменения согласных'],
		[2,'c→<strong class=insert>zc</strong>'],
			v3('conocer').yo('cono{zc}'),
		[2,'c→<strong class=insert>zc</strong>,<strong>j</strong>'],
			v3('producir','производить').yo('produ{zc}').pret('produ[j]'),
		[1,'прочие изменения'],
		[2,'-<strong>y</strong>endo'],
			v3('creer','верить').yendo(),
		[2,'+u→<strong class=insert>uy</strong>'],
			v3('construir','строить').yendo().vowel('uy').yo('constr{uy}'),
		[2,'<abbr title=participio>part.</abbr> <abbr title=irregular>irreg.</abbr>'], // https://es.wiktionary.org/wiki/Categor%C3%ADa:ES:Verbos_con_participio_irregular
			v3('escribir').replace({
				par:'escri[t]|{}o',
			}),
			v3('abrir').replace({
				par:'ab{iert}|{}o',
			}),
			v3('romper','ломать').replace({
				par:'ro{t}|{}o',
			}),
			v3('pudrir','разлагать').replace({
				par:'p[o]dr|ido',
			}),
		[2,'<abbr title=participio>part.</abbr> <abbr title=irregular>irreg.</abbr> + другие'],
			v3('elegir','выбирать').vowel('i','i').replace({
				par:'ele{ct}|{}o', // TODO also elegido
			}),
			v3('volver','возвращаться').vowel('ue').replace({
				par:'v{ue}l[t]|{}o',
			}),
		[1,'irregularidad propia','индивидуальное спряжение'],
			v3('estar').pret('est{uv}').replace({
				pres_s:'est|o{y},est|[á]s,est|[á]',
				pres3p:'est|[á]n',
				im2s:'est|[á]',im3s:'est|[é]',im3p:'est|[é]n',
				subj_s:'est|[é],est|[é]s,est|[é]',
				subj3p:'est|[é]n',
			}),
			v3('ser').yo('s{e}').replace({
				pres__:'s|o{y},{er}|es,{es}|[],s|[o]mos,s|[o]is,s|[o]n',
				pret__:'{fu}|[i],{fu}|iste,{fu}|[e],{fu}|imos,{fu}|isteis,{fu}|{}eron',
				imp__:'{er}|{}|a,{er}|{}|as,{er}|{}|a,{ér}|{}|amos,{er}|{}|ais,{er}|{}|an',
				im2s:'s|[é]',
			}),
			v3('ir').yo('{vay}').replace({
				ger:'|[y]endo',
				pres__:'{v}|o{y},{v}|[a]s,{v}|[a],{v}|[a]mos,{v}|{ai}s,{v}|[a]n',
				pret__:'{fu}|[i],{fu}|iste,{fu}|[e],{fu}|imos,{fu}|isteis,{fu}|{}eron',
				imp__:'{ib}|{}|a,{ib}|{}|as,{ib}|{}|a,{íb}|{}|amos,{ib}|{}|ais,{ib}|{}|an',
				im2s:'{v}|e',
			}),
			v3('dar').pret('d').replace({
				pres1s:'d|o{y}',
				pres2p:'d|[a]is',
				pret1s:'d|[i]',
				pret3s:'d|{io}',
				subj1s:'d|[é]',
				subj3s:'d|[é]',
				im3s:'d|[é]',
			}),
			v3('ver').yo('v{e}').imp('v{e}').replace({
				par:'v|i{st}o',
				pres2p:'v|[e]is',
				pret1s:'v|[i]',
				pret3s:'v|i[o]',
			}),
			v3('oír','слышать').vowel('oy').yo('o{ig}').yendo().replace({
				inf:'o|[í]r',
				pres1p:'o|[í]mos',
				im2p:'o|[í]d',
			}),
			v3('traer','приносить').yendo().yo('tra{ig}').pret('tra{j}'),
			v3('haber').yo('ha[y]').pret('h[u]b').fut('hab').replace({
				pres__:'h{}|[e],h{}|[a]s,h{}|[a],h{}|emos,hab|éis,h{}|[a]n',
				im2s:'h{}|e',
			}),
			v3('saber').yo('s[ep]').pret('s[up]').fut('sab').replace({
				pres1s:'s{}|[é]',
			}),
			v3('poder').vowel('ue').pret('p[u]d').fut('pod').replace({
				ger:'p[u]d|iendo', // TODO vowel-raising
			}),
			v3('querer').vowel('ie').pret('qu[is]').fut('quer'),
			v3('hacer').yo('ha[g]').pret('h[i]c').fut('ha{}').replace({
				par:'h{ech}|{}o',
				pret3s:'h[iz]|[o]', // TODO this is otho change
				im2s:'ha[z]|{}',
			}),
			v3('decir').vowel('i','i').yo('d[ig]').pret('d[ij]').fut('d[i]{}').replace({
				par:'d{ich}|{}o',
				im2s:'d[i]{}|{}',
			}),
			v3('poner','ставить').yo('pon{g}').pret('p[us]').fut('pon{d}').replace({
				par:'p{uest}|{}o',
				im2s:'pon|{}',
			}),
			v3('tener').vowel('ie').yo('ten{g}').pret('t[uv]').fut('ten{d}').replace({
				im2s:'ten|{}',
			}),
			v3('venir').vowel('ie','i').yo('ven{g}').pret('v[i]n').fut('ven{d}').replace({
				im2s:'ven|{}',
			}),
			v3('salir').yo('sal{g}').fut('sal{d}').replace({
				im2s:'sal|{}',
			}),
		[1,'оставшиеся глаголы в произвольном порядке'],
			v3('leer').yendo(),
			v3('seguir','следовать').vowel('i','i'),
			v3('empezar','начинать').vowel('ie'),
			v3('perder').vowel('ie'),
			v3('entender','понимать').vowel('ie'),
			v3('encontrar','находить').vowel('ue'),
			v3('recordar','помнить').vowel('ue'),
			v3('mover','двигать').vowel('ue'),
			v3('parecer','казаться').yo('pare{zc}'),
			v3('conducir','вести').yo('condu{zc}').pret('condu[j]'),
			v3('quedar','оставаться'),
			v3('hablar','говорить'),
			v3('llevar','нести'),
			v3('dejar','оставлять'),
			v3('llamar','звать'),
			v3('tomar'),
			v3('tratar','пытаться'),
			v3('mirar','смотреть'),
			v3('esperar','ждать'),
			v3('tocar','трогать'),
			v3('comer','есть'),
			v3('existir','существовать'),
			v3('entrar','входить'),
			v3('trabajar','работать'),
			v3('ocurrir','происходить'),
			v3('recibir','получать'),
			v3('terminar','кончать'),
			v3('permitir','разрешать'),
			v3('aparecer','появляться').yo('apare{zc}'), // TODO merge with parecer
			v3('conseguir','получать').vowel('i','i'), // TODO merge with seguir
			v3('comenzar','начинать').vowel('ie'),
			v3('servir','служить').vowel('i','i'),
			v3('sacar','вынимать'),
			v3('necesitar','нуждаться'),
			v3('mantener','содержать').vowel('ie').yo('manten{g}').pret('mant[uv]').fut('manten{d}').replace({
				im2s:'mantén|{}',
			}), // TODO merge with tener, won't quite work for im2s
			v3('resultar','получаться'),
			v3('caer','падать').yendo().yo('ca{ig}'),
			v3('cambiar','менять'),
			v3('presentar','представлять'),
			v3('crear','создавать'),
			v3('considerar','обдумывать'),
			v3('acabar','кончать'),
			v3('convertir','становиться').vowel('ie','i'),
			// added for translations from Italian
			v3('habitar'),
			v3('vender'),
			v3('estudiar'),
			v3('comprender'),
			v3('responder'),
			v3('ofrecer').yo('ofre{zc}'),
			v3('cerrar').vowel('ie'),
			v3('beber'),
			v3('gustar'),
			v3('meter'),
			v3('nacer').yo('na{zc}'),
			v3('morir').vowel('ue','u').replace({
				par:'m{uert}|{}o',
			}),
			v3('permanecer').yo('permane{zc}'),
			v3('pagar'),
		]
	}
	provideFrequencyVerbs() {
		return (
			'ser,haber,estar,tener,hacer,poder,decir,ir,ver,dar,'+
			'saber,querer,llegar,pasar,deber,poner,parecer,quedar,creer,hablar,'+
			'llevar,dejar,seguir,encontrar,llamar,venir,pensar,salir,volver,tomar,'+
			'conocer,vivir,sentir,tratar,mirar,contar,empezar,esperar,buscar,existir,'+
			'entrar,trabajar,escribir,perder,producir,ocurrir,entender,pedir,recibir,recordar,'+
			'terminar,permitir,aparecer,conseguir,comenzar,servir,sacar,necesitar,mantener,resultar,'+
			'leer,caer,cambiar,presentar,crear,abrir,considerar,oír,acabar,convertir'
		).split(',') // Mark Davies, A Frequency Dictionary of Spanish, 2006
	}
}

class ItalianVerb extends Verb {
	constructor(title,translation) {
		super(title,translation)
		this.forms={}
		this.iscFlag=false
		this.futStem=undefined
	}
	get wiktionary() {
		return "<a href=https://it.wiktionary.org/wiki/Appendice:Coniugazioni/Italiano/"+this.title+">[w]</a>"
	}
	getForm(formId) { // https://it.wiktionary.org/wiki/Template:It-conj
		const replaceEnd=(s,e)=>s.replace(/\|.*$/,'|'+e)
		const removeDoubleI=(s)=>s.replace(/i\|i/,'{}|i')
		if (formId in this.forms) return this.forms[formId]
		let stem=this.title.slice(0,-3)
		let infEnd=this.title.slice(-3)
		let tl=infEnd[0]
		let iscEndBar=this.iscFlag?'{isc}|':'|'
		let futBase=stem+'|'+(infEnd=='ire' ? 'i' : 'e')
		if (infEnd=='are' && stem.match(/[cg]$/)) {
			futBase=stem+'{h}|e'
		}
		if (this.futStem!==undefined) {
			futBase=this.futStem+'|{}'
			if (this.futStem.includes('|')) futBase=this.futStem
		}
		if (formId=='inf') {
			return stem+'|'+infEnd
		} else if (formId=='ger') {
			if (infEnd=='are') {
				return stem+'|ando'
			} else {
				return stem+'|endo'
			}
		} else if (formId=='par') {
			if (infEnd=='are') {
				return stem+'|ato'
			} else if (infEnd=='ere') {
				return stem+'|uto'
			} else {
				return stem+'|ito'
			}
		} else if (formId=='pres1s') {
			return stem+iscEndBar+'o'
		} else if (formId=='pres2s') {
			if (infEnd=='are' && stem.match(/[cg]$/)) {
				return stem+'{h}|i'
			} else {
				return removeDoubleI(stem+iscEndBar+'i')
			}
		} else if (formId=='pres3s') {
			return stem+iscEndBar+(infEnd=='are' ? 'a' : 'e')
		} else if (formId=='pres1p') {
			if (infEnd=='are' && stem.match(/[cg]$/)) {
				return stem+'{h}|iamo'
			} else {
				return removeDoubleI(stem+'|iamo')
			}
		} else if (formId=='pres2p') {
			return stem+'|'+infEnd[0]+'te'
		} else if (formId=='pres3p') {
			return stem+iscEndBar+(infEnd=='are' ? 'ano' : 'ono')
		} else if (formId=='imp1s') {
			return stem+'|'+tl+'vo'
		} else if (formId=='imp2s') {
			return stem+'|'+tl+'vi'
		} else if (formId=='imp3s') {
			return stem+'|'+tl+'va'
		} else if (formId=='imp1p') {
			return stem+'|'+tl+'vamo'
		} else if (formId=='imp2p') {
			return stem+'|'+tl+'vate'
		} else if (formId=='imp3p') {
			return stem+'|'+tl+'vano'
		} else if (formId=='fut1s')  { return futBase+'r|ò'
		} else if (formId=='fut2s')  { return futBase+'r|ai'
		} else if (formId=='fut3s')  { return futBase+'r|à'
		} else if (formId=='fut1p')  { return futBase+'r|emo'
		} else if (formId=='fut2p')  { return futBase+'r|ete'
		} else if (formId=='fut3p')  { return futBase+'r|anno'
		} else if (formId=='cond1s') { return futBase+'r|ei'
		} else if (formId=='cond2s') { return futBase+'r|esti'
		} else if (formId=='cond3s') { return futBase+'r|ebbe'
		} else if (formId=='cond1p') { return futBase+'r|emmo'
		} else if (formId=='cond2p') { return futBase+'r|este'
		} else if (formId=='cond3p') { return futBase+'r|ebbero'
		} else if (formId=='im2s') {
			if (infEnd=='are') {
				return stem+iscEndBar+'a'
			} else {
				return this.getForm('pres2s')
			}
		} else if (formId=='im3s') {
			if (infEnd=='are' && stem.match(/[cg]$/)) {
				return stem+'{h}|i'
			} else {
				return removeDoubleI((replaceEnd(this.getForm('pres1s'),infEnd=='are'?'i':'a')))
			}
		} else if (formId=='im1p') {
			return this.getForm('pres1p')
		} else if (formId=='im2p') {
			return this.getForm('pres2p')
		} else if (formId=='im3p') {
			if (infEnd=='are' && stem.match(/[cg]$/)) {
				return stem+'{h}|ino'
			} else {
				return removeDoubleI((replaceEnd(this.getForm('pres1s'),infEnd=='are'?'ino':'ano')))
			}
		}
	}
	isc() {
		this.iscFlag=true
		return this
	}
	fut(stem) {
		this.futStem=stem
		return this
	}
}

class ItalianLanguage extends Language {
	get title() {
		return 'итальянский'
	}
	get code() {
		return 'it'
	}
	isVerbFormCompactible(formId) {
		return formId=='imp3' || formId=='cond3'
	}
	getVerbFormTitle(formId) {
		return {
			nonpers: ['','безличные формы'], // don't display group title
			inf: ['infinito','инфинитив'],
			//par: ['participio passato','страдательное(?) причастие прошедшего времени, меняется по родам и числам'],
			par: ['<abbr title=participio>p.</abbr><abbr title=passato>pass.</abbr>','страдательное(?) причастие прошедшего времени, меняется по родам и числам'],
			ger: ['gerundio','для образования аналога continuous в английском по схеме спряжённый-stare + ger.'],
			pres: ['presente','presente'],
			pres1s: ['io',`я делаю`],
			pres2s: ['tu',`ты делаешь`],
			pres3s: ['lui/lei',`он/она делает`],
			pres1p: ['noi',`мы делаем`],
			pres2p: ['voi',`вы делаете`],
			pres3p: ['loro',`они делают`],
			imp: ['imperfetto','imperfetto'],
			imp1s: ['io',`я делал`],
			imp2s: ['tu',`ты делал`],
			imp3s: ['lui/lei',`он/она делал(а)`],
			imp1p: ['noi',`мы делали`],
			imp2p: ['voi',`вы делали`],
			imp3p: ['loro',`они делали`],
			imp3: ['lui/lei/<em>loro</em>','он/она/они делал(а/и)'],
			fut: ['futuro','futuro semplice'], // утверждения и предсказания о будущем
			fut1s: ['io',`я сделаю`],
			fut2s: ['tu',`ты сделаешь`],
			fut3s: ['lui/lei',`он/она сделает`],
			fut1p: ['noi',`мы сделаем`],
			fut2p: ['voi',`вы сделаете`],
			fut3p: ['loro',`они сделают`],
			cond: ['condizionale','condizionale presente'], // будущие гипотетические ситуации, желания, вежливые просьбы и советы
			cond1s: ['io',`я бы сделал`],
			cond2s: ['tu',`ты бы сделал`],
			cond3s: ['lui/lei',`он/она бы сделал(а)`],
			cond1p: ['noi',`мы бы сделали`],
			cond2p: ['voi',`вы бы сделали`],
			cond3p: ['loro',`они бы сделали`],
			cond3: ['lui/lei/<em>loro</em>','он/она/они бы сделал(а/и)'],
			im: ['imperativo','imperativo'],
			im2s: ['tu','ты сделай; для не-are глаголов форма обычно совпадает с presente'],
			im3s: ['Lei','(вежливое) вы сделайте'],
			im1p: ['noi','давайте мы сделаем; форма обычно совпадает с presente'],
			im2p: ['voi','(множественное) вы сделайте; форма обычно совпадает с presente'],
			im3p: ['Loro','(вежливое множественное) вы сделайте'],
		}[formId]
	}
	getVerbs() {
		return this.verbs
	}
	listPersonalVerbForms() {
		return ['pres','imp','fut','cond','im']
	}
	listSelectableVerbForms() {
		return ['ger','par',...this.listPersonalVerbForms()]
	}
	provideTopicVerbs() {
		const v=(...args)=>(new ItalianVerb(...args))
		return [
		[1,'правильные'],
		[2,'1-е <abbr title=спряжение>спряж.</abbr>'],
			v('abitare'),
		[2,'2-е <abbr title=спряжение>спряж.</abbr>'],
			v('vendere'),
		[2,'3-е <abbr title=спряжение>спряж.</abbr>'],
			v('sentire'),
		[1,'почти'],
		[2,'-i-'],
			v('studiare'),
		[2,'орфографические'],
			v('pagare'),
			v('giocare'),
		[2,'-isc-'],
			v('capire').isc(),
		[1,'неправильные причастия'],
		[2,'1 согласная в окончании'],
			v('conoscere').replace({par:'conosc{i}|uto'}),
			v('nascere').replace({par:'n{}|[a]to'}),
			v('chiudere').replace({par:'chi{}|u[s]o'}),
			v('prendere').replace({par:'pr{}|[es]o'}),
		[2,'2 согласные в окончании'],
			v('mettere').replace({par:'m{}|[e]{ss}o'}),
			v('rispondere').replace({par:'risp{}|[o]{st}o'}),
			v('scrivere').replace({par:'scr{}|[i]{tt}o'}),
			v('leggere').replace({par:'l{}|[e]{tt}o'}),
			v('offrire').replace({par:'off{}|[e]{rt}o'}),
			v('aprire').replace({par:'ap{}|[e]{rt}o'}),
			v('perdere').replace({par:'p{}|[e]{rs}o'}),
		[2,'+будущ.'],
			v('vedere').fut('ved').replace({par:'v{}|[i]{st}o'}),
		[1,'неправильные'],
			v('essere').fut('{s}|[a]').replace({
				par:'{st}|[a]to',
				pres__:'{son}|o,{se}|i,{}|[è],{s}|iamo,{si}|ete,{son}|o',
				imp__:'e{r}|{}o,e{r}|{}i,e{r}|{}a,e{r}|[a]vamo,e{r}|[a]vate,e{r}|{}ano',
				im2_:'{si}|i,{si}|ate',
				im3_:'{si}|a,{si}|ano',
			}),
			v('avere').fut('av').replace({
				pres_s:'{h}|o,{ha}|i,{h}|[a]',
				pres1p:'a{bb}|iamo',
				pres3p:'{h}|[a]{nn}o',
				im2_:'a{bb}|i,a{bb}|{i}ate',
				im3_:'a{bb}|{i}a,a{bb}|{i}ano',
			}),
			v('andare').fut('and').replace({
				pres_s:'{vad}|o,{va}|i,{v}|a',
				pres3p:'{v}|a{nn}o',
				im2s:"{va}|{'}", // TODO: vai = full form
				im3_:'{vad}|[a],{vad}|[a]no',
			}),
			v('fare').fut('f|[a]').replace({
				ger:'f{ac}|[e]ndo',
				par:'f|a{tt}o',
				pres1s:'f{acci}|o',
				pres2s:'f{a}|i',
				pres1p:'f{acc}|iamo',
				pres3p:'f|a{nn}o',
				imp__:'f{ac}|[e]vo,f{ac}|[e]vi,f{ac}|[e]va,f{ac}|[e]vamo,f{ac}|[e]vate,f{ac}|[e]vano',
				im2s:'f{a}|[i]', // TODO: fa' = short form
				im3_:'f{acci}|[a],f{acci}|[a]no',
			}),
			v('dare').fut('d|[a]').replace({
				pres2s:'d{a}|i',
				pres3s:'d|[à]',
				pres3p:'d|a{nn}o',
				im2s:'d{a}|[i]', // TODO: da', dà = short form
				im3_:'d|i{a},d|i{a}no',
			}),
			v('sapere').fut('sap').replace({
				pres_s:'s{}|o,sa{}|i,s{}|[a]',
				pres1p:'sa{pp}|iamo',
				pres3p:'s{}|[a]{nn}o',
				im2_:'sa{pp}|i,sa{pp}|{i}ate',
				im3_:'sa{pp}|{i}a,sa{pp}|{i}ano',
			}),
			v('volere').fut('vo[r]').replace({
				pres_s:'vo{gli}|o,v{uo}|i,v{uol}|e',
				pres1p:'vo{gl}|iamo',
				pres3p:'vo{gli}|ono',
				//im2s: TODO: vogli
				//im2p: TODO: vogliate
			}),
			v('dovere').fut('dov').replace({
				pres_s:'d[e]v|o,d[e]v|i,d[e]v|e', // TODO debbo, debbono
				pres1p:'do{bb}|iamo',
				pres3p:'d[e]v|ono',
				im__:undefined,
			}),
			v('potere').fut('pot').replace({
				pres_s:'po{ss}|o,p{uo}{}|i,p[u]{}|[ò]',
				pres1p:'po{ss}|iamo',
				pres3p:'po{ss}|ono',
				im__:undefined,
			}),
			v('rimanere').fut('rima[r]').replace({
				par:'rim{}|[a]{st}o',
				pres1s:'riman{g}|o',
				pres3p:'riman{g}|ono',
			}),
			v('tenere').fut('te[r]').replace({
				pres_s:'ten{g}|o,t{ie}n|i,t{ie}n|e',
				pres3p:'ten{g}|ono',
			}),
			v('venire').fut('ve[r]').replace({
				par:'ven|[u]to',
				pres_s:'ven{g}|o,v{ie}n|i,v{ie}n|e',
				pres3p:'ven{g}|ono',
			}),
			v('dire').replace({
				ger:'d{ic}|endo',
				par:'d|[e]{tt}o',
				pres_s:'d{ic}|o,d{ic}|i,d{ic}|e',
				pres1p:'d{ic}|iamo',
				pres3p:'d{ic}|ono',
				imp__:'d{ic}|[e]vo,d{ic}|[e]vi,d{ic}|[e]va,d{ic}|[e]vamo,d{ic}|[e]vate,d{ic}|[e]vano',
				im2s:"d|i{'}",
			}),
			v('bere').fut('b{er}').replace({
				ger:'b{ev}|endo',
				par:'b{ev}|uto',
				pres__:'b{ev}|o,b{ev}|i,b{ev}|e,b{ev}|iamo,b{ev}|ete,b{ev}|ono',
				imp__:'b{ev}|evo,b{ev}|evi,b{ev}|eva,b{ev}|evamo,b{ev}|evate,b{ev}|evano',
			}),
			v('uscire').replace({
				pres_s:'[e]sc|o,[e]sc|i,[e]sc|e',
				pres3p:'[e]sc|ono',
			}),
			v('stare').fut('st|[a]').replace({
				pres2s:'st{a}|i',
				pres3p:'st|a{nn}o',
				im2s:'st{a}|i',
				im3_:'st|{i}[a],st|{i}[a]no',
			}),
			v('piacere').replace({ // possibly ortho change ce -> ci(vowel)
				par:'piac{i}|uto',
				pres1s:'piac{ci}|o',
				pres1p:'piac{c}|iamo',
				pres3p:'piac{ci}|ono',
			}),
			v('morire').replace({
				par:'m{}|[o]{rt}o',
				pres_s:'m{uo}{}{i}|o,m{uo}r|i,m{uo}r|e',
				pres3p:'m{uo}{}{i}|ono',
				// также есть форма будущего morrò - но она, видимо, устаревшая
			}),
		[1,'прочие'], // для перевода
			v('passare'),
			v('vivere').fut('viv').replace({par:'vi{ss}|uto'}),
		]
	}
	// freq:
	// essere,avere,fare,potere,stare,venire,vedere,volere,dire,dovere,dare [Alphonse Juilland, Vicenzo Traversa]
	// essere,avere,potere,fare,dire,dovere,stare,venire,vedere,volere,andare,sapere,sembrare,prendere,mettere [Gianpaolo Intronati]
	// essere,avere,fare,sapere,andare,dire,volere,stare,potere,dovere,vedere,porre,venire,guardare,sembrare,parlare,dispiacere,aspettare,piacere,pensare,bastare,portare,sentire,prendere,ideare,capire,succedere,volgere,trovare,dare,servire,leggere,scusare [J.L. Laide]
	provideFrequencyVerbs() {
		return 'essere,avere,fare,sapere,andare,dire,volere,stare,potere,dovere'.split(',')
	}
}

const languages={
	es: new SpanishLanguage(),
	it: new ItalianLanguage(),
}

for (const [es,it,ru] of [
	['abrir','aprire','открывать'],
	['beber','bere','пить'],
	['cerrar','chiudere','закрывать'],
	['comprender','capire','понимать'],
	['conocer','conoscere',['знать','знать человека/место, быть знакомым']],
	['dar','dare','давать'],
	['deber','dovere','<abbr title=быть>б.</abbr> должным'],
	['decir','dire','сказать'],
	['escribir','scrivere','писать'],
	['estar','stare',{es:['быть','быть временно, быть в указанном месте'],it:'оставаться'}],
	['estudiar','studiare','изучать'],
	['gustar','piacere','нравиться'],
	['haber','avere',['иметь','вспомогательный для сложных времён']], // also es:tener
	['habitar','abitare','проживать'],
	['hacer','fare','делать'],
	['ir','andare','идти'],
	['jugar','giocare','играть'],
	['leer','leggere','читать'],
	['meter','mettere','класть'],
	['morir','morire','умирать'],
	['nacer','nascere','рождаться'],
	['ofrecer','offrire','предлагать'],
	['pagar','pagare','платить'],
	['pasar','passare','проходить'],
	['perder','perdere','терять'],
	['permanecer','rimanere','оставаться'],
	['poder','potere','мочь'],
	['querer','volere','хотеть'],
	['responder','rispondere','отвечать'],
	['saber','sapere',['знать','знать факт/навык']],
	['salir','uscire','выходить'],
	['sentir','sentire','чувствовать'],
	['ser','essere',{es:['быть','быть постоянно, быть в указанный момент времени'],it:'быть'}],
	['tener','tenere',{es:'иметь',it:'держать'}],
	['tomar','prendere','брать'],
	['vender','vendere','продавать'],
	['venir','venire','приходить'],
	['ver','vedere','видеть'],
	['vivir','vivere','жить'],
]) {
	languages.es.getVerbs()[es].translation={ru:ru.es||ru,it}
	languages.it.getVerbs()[it].translation={ru:ru.it||ru,es}
}

const readPair=(a)=>Array.isArray(a)?a:[a,'']

function createConjugationTable($container,languageType,sortType,formSet,orderType,tableType) {
	let language=languages[languageType]
	function cellClickHandler() {
		//if (this.dataset.formId2) {
			this.classList.add('combination')
		//}
	}
	function cellAnimationEndHandler() {
		this.classList.remove('combination')
	}
	$container.classList.add('conjtable')
	const $table=document.createElement('table')
	$table.setAttribute('lang',language.code)
	const $thead=document.createElement('thead')
	$table.appendChild($thead)
	const blankLead=tableType=='side'?"<th colspan=2>":"<th>"
	const catCell=($row,parent,colspan)=>{
		let [title,titleNote]=readPair(parent)
		const $cell=document.createElement('th')
		$row.appendChild($cell)
		if (title) $cell.innerHTML=title
		if (titleNote) $cell.setAttribute('title',titleNote)
		$cell.setAttribute('colspan',colspan)
	}
	{ // header row 1
		const $row=$thead.insertRow()
		$row.innerHTML=blankLead
		for (const [category,...subcategories] of language.getVerbOrder(orderType)) {
			let colspan=0
			for (const [subcategory,...verbIds] of subcategories) {
				colspan+=verbIds.length
			}
			catCell($row,category,colspan)
		}
	}
	{ // header row 2
		const $row=$thead.insertRow()
		$row.innerHTML=blankLead
		for (const [category,...subcategories] of language.getVerbOrder(orderType)) {
			for (const [subcategory,...verbIds] of subcategories) {
				catCell($row,subcategory,verbIds.length)
			}
		}
	}
	const compareLanguages=[
		languages[languageType=='es'?'it':'es']
	]
	for (const [formGroupId,formGroupRows] of language.getVerbFormOrder(sortType,formSet,compareLanguages)) {
		const [formGroupName,formGroupLongName]=language.getVerbFormTitle(formGroupId)
		const $tbody=document.createElement('tbody')
		$table.appendChild($tbody)
		if (tableType!='side') {
			const nCols=[...language.listVerbs(orderType)].length+1
			$tbody.insertRow().insertAdjacentHTML('beforeend',`<th colspan=${nCols} class=widegroup><span>${formGroupLongName}</span>`)
		}
		let firstInGroup=true
		for (const [verbLanguage,joinAbove,joinBelow,formId,verbFormIds] of formGroupRows) {
			const $row=$tbody.insertRow()
			if (joinAbove) $row.classList.add('join-above')
			if (joinBelow) $row.classList.add('join-below')
			if (tableType=='side' && firstInGroup && formGroupName) {
				let cls='group'
				if (formGroupRows.length<5 && formGroupName.length>10) cls="'group long'"
				if (formGroupRows.length<4 && formGroupName.length>10) cls="'group very-long'"
				$row.insertAdjacentHTML('beforeend',`<th class=${cls} rowspan=${formGroupRows.length}><span>${formGroupName}</span>`)
			}
			firstInGroup=false
			const $formCell=document.createElement('th')
			if (tableType=='side') {
				if (formGroupName) {
					$formCell.classList.add('subgroup')
				} else {
					$formCell.classList.add('spangroup')
					$formCell.setAttribute('colspan',2)
				}
			} else {
				$formCell.classList.add('spangroup')
			}
			$row.appendChild($formCell)
			if (verbLanguage.code==languageType) {
				const [formText,formNote]=language.getVerbFormTitle(formId)
				$formCell.innerHTML=formText
				$formCell.setAttribute('title',formNote)
				if (tableType!='side' || formGroupName) {
					const formRawText=formText.replace(/<[^>]*>/g,'')
					if (formRawText.length>10) {
						$formCell.classList.add('very-long')
					} else if (formRawText.length>5) {
						$formCell.classList.add('long')
					}
				}
			} else {
				$formCell.innerHTML=`(${verbLanguage.code})`
				$row.classList.add('compare')
			}
			const getFormHtml=(form)=>{
				if (form===undefined) return ''
				const [stem,end,subend]=form.split('|')
				const mark=(s)=>s.replace(/\[(.*?)\]/g,'<strong>$1</strong>').replace(/\{(.*?)\}/g,'<strong class=insert>$1</strong>')
				const makeSpan=(cls,s)=>s?`<span class=${cls}>${mark(s)}</span>`:''
				let t=makeSpan('stem',stem)+makeSpan('end',end)
				if (subend!==undefined) t+=makeSpan('subend',subend)
				return t
			}
			const combineForms=(shortForm,longForm)=>{
				const d=longForm.length-shortForm.length
				let i=0
				for (;i<shortForm.length;i++) {
					if (shortForm[i]!=longForm[i]) break
				}
				let j=shortForm.length-1
				for (;j>=0;j--) {
					if (shortForm[j]!=longForm[j+d]) break
				}
				if (i!=j+1) return [false]
				return [true,longForm.slice(0,i),longForm.slice(i,i+d),longForm.slice(i+d)]
			}
			for (const baseVerb of language.listVerbs(orderType)) {
				const $cell=$row.insertCell()
				let verb=baseVerb
				if (verbLanguage.code!=languageType) {
					verb=verbLanguage.getVerbs()[verb.translation[verbLanguage.code]]
					$cell.setAttribute('lang',verbLanguage.code)
				}
				if (!verb) continue
				const verbForms=verbFormIds.map(id=>verb.getForm(id))
				let doneVerbForms=false
				if (verbForms.length==2) {
					const [isCombined,preMarked,inMarked,postMarked]=combineForms(...verbForms)
					if (isCombined) {
						$cell.innerHTML=getFormHtml(`${preMarked}<em>${inMarked}</em>${postMarked}`)
						$cell.addEventListener('click',cellClickHandler)
						$cell.addEventListener('animationend',cellAnimationEndHandler)
						doneVerbForms=true
					}
				}
				if (!doneVerbForms) {
					$cell.innerHTML=verbForms.map(getFormHtml).join(" / ")
				}
				const uniqueFormNotes={}
				for (const note of verbFormIds.map(id=>verb.getFormNote(id))) {
					if (note) uniqueFormNotes[note]=true
				}
				const combinedNote=Object.keys(uniqueFormNotes).join(" / ")
				if (combinedNote) $cell.setAttribute('title',combinedNote)
				//$cell.dataset.formId=formId
				//$cell.dataset.verb=verb.title
			}
		}
	}
	{
		const $tbody=document.createElement('tbody')
		$table.appendChild($tbody)
		{
			const $row=$tbody.insertRow()
			$row.setAttribute('lang','ru')
			$row.innerHTML=blankLead
			for (const verb of language.listVerbs(orderType)) {
				const [translation,translationNote]=readPair(verb.translation.ru)
				const $cell=$row.insertCell()
				$cell.innerHTML=translation
				if (translationNote) $cell.setAttribute('title',translationNote)
			}
		}
		{
			const $row=$tbody.insertRow()
			$row.innerHTML=blankLead
			for (const verb of language.listVerbs(orderType)) {
				$row.insertCell().innerHTML=verb.wiktionary
			}
		}
	}
	$container.appendChild($table)
}

function createConjugationGame($container,formSet) {
	let language=languages.es
	const gameVerbs=[]
	for (const verb of language.listVerbs('topic')) { // TODO receive list of verbs, for example to play with 20 most frequent verbs
		for (const formId of verb.listForms()) {
			if (formId=='inf') continue
			if (formId in formSet && !formSet[formId]) continue
			const [formGroupId,]=formId.split(/(\d)/)
			if (formGroupId in formSet && !formSet[formGroupId]) continue
			gameVerbs.push([verb,formId])
		}
	}
	const shuffle=(a)=>{
		let i=a.length
		while (i>0) {
			let j=Math.floor(Math.random()*i)
			i-=1
			;[a[i],a[j]]=[a[j],a[i]]
		}
	}
	shuffle(gameVerbs)
	let iCurrentGameVerb=0
	$container.classList.add('conjgame')
	const $table=document.createElement('table')
	$container.appendChild($table)
	const createNextQuestion=()=>{
		if (iCurrentGameVerb>=gameVerbs.length) return
		const [verb,formId]=gameVerbs[iCurrentGameVerb]
		const $tbody=document.createElement('tbody')
		$table.appendChild($tbody)
		const $infRow=$tbody.insertRow()
		$infRow.insertAdjacentHTML('beforeend',"<th colspan=2>")
		$infRow.insertCell().innerHTML=verb.title
		const $formRow=$tbody.insertRow()
		const [formGroupId,n]=formId.split(/(\d)/)
		if (n) {
			const [,formGroupTitle]=language.getVerbFormTitle(formGroupId)
			const [formTitle]=language.getVerbFormTitle(formId)
			$formRow.insertAdjacentHTML('beforeend',`<th>${formGroupTitle},<th>${formTitle}`)
		} else {
			const [formTitle]=language.getVerbFormTitle(formId)
			$formRow.insertAdjacentHTML('beforeend',`<th colspan=2>${formTitle}`)
		}
		const $formInputTd=$formRow.insertCell()
		const $formInput=document.createElement('input')
		$formInputTd.appendChild($formInput)
		const $formButtonTd=$formRow.insertCell()
		const $formButton=document.createElement('button')
		$formButton.innerHTML='Проверить'
		$formButtonTd.appendChild($formButton)
		$formButton.addEventListener('click',()=>{
			const userForm=$formInput.value
			$formInputTd.removeChild($formInput)
			$formButtonTd.removeChild($formButton)
			$formInputTd.insertAdjacentText('beforeend',userForm)
			const form=verb.getRawForm(formId)
			if (userForm==form) {
				$formButtonTd.insertAdjacentHTML('beforeend',"<span class=correct>Правильно</span>")
			} else {
				$formButtonTd.insertAdjacentHTML('beforeend',"<span class=incorrect>Неправильно</span>")
				$tbody.insertRow().innerHTML=`<th colspan=2>Правильный ответ<td>${form}`
			}
			iCurrentGameVerb++
			createNextQuestion()
		})
	}
	createNextQuestion()
}

function createOptions($featureContainer,$optionsContainer) {
	const createBlock=(title,labelFor)=>{
		const $block=document.createElement('div')
		$block.classList.add('block')
		if (labelFor) {
			$block.innerHTML=`<div><label for=${labelFor}>${title}:</label></div>`
		} else {
			$block.innerHTML=`<div>${title}:</div>`
		}
		return $block
	}
	const createControl=($block,html,handler)=>{
		const $control=document.createElement('div')
		$control.innerHTML=html
		$control.addEventListener('change',handler)
		$block.appendChild($control)
	}
	const options={}
	const createOptionBlock=(title,name,valuesAndTexts,handler)=>{
		const storageKey='glaconjurer-'+name
		options[name]=valuesAndTexts[0][0]
		const storedValue=localStorage.getItem(storageKey)
		for (const [v,t] of valuesAndTexts) if (v==storedValue) options[name]=v
		const selectId='options-'+name
		const $block=createBlock(title,selectId)
		createControl($block,`<select id=${selectId}>`+
			valuesAndTexts.map(([v,t])=>`<option value=${v+(v==options[name]?' selected':'')}>${t}</option>`).join('')
		+"</select>",ev=>{
			const oldValue=options[name]
			const newValue=ev.target.value
			localStorage.setItem(storageKey,newValue)
			options[name]=newValue
			handler(newValue,oldValue)
		})
		return $block
	}
	let needToCreateFeature=false
	let form$blocks={}
	const $languageBlock=createOptionBlock(
		"Язык",'language',
		Object.values(languages).map(language=>[language.code,language.title]),
		(newValue,oldValue)=>{
			form$blocks[oldValue].classList.remove('open')
			form$blocks[newValue].classList.add('open')
			needToCreateFeature=true
		}
	)
	const $featureBlock=createOptionBlock("Режим",'feature',[
		['conjtable','таблица спряжений'],
		['conjgame','игра'],
	],()=>{
		needToCreateFeature=true
	})
	const $tableBlock=createOptionBlock("Вид таблицы спряжений",'table',[
		['side','время сбоку от форм глаголов'],
		['top','время сверху от форм глаголов'],
	],()=>{
		if (options.feature=='conjtable') needToCreateFeature=true
	})
	const $sortBlock=createOptionBlock("Отображение спряжений по лицам и числам",'sort',[
		['number','обычный порядок'],
		['number-compare','...со сравнением с другим языком'],
		['person','группировка по лицам'],
		['person-compact','...с уплотнением'],
	],()=>{
		if (options.feature=='conjtable') needToCreateFeature=true
	})
	const $orderBlock=createOptionBlock("Порядок и набор глаголов",'order',languages.es.listVerbOrders(),()=>{ // TODO make verb orders universal
		if (options.feature=='conjtable') needToCreateFeature=true
	})
	options.forms={}
	for (const [langId,lang] of Object.entries(languages)) {
		options.forms[langId]={}
		for (const formId of lang.listSelectableVerbForms()) {
			const v=localStorage.getItem(`glaconjurer-form-${langId}-${formId}`)
			options.forms[langId][formId]=v!='0'
		}
		const $block=createBlock("Формы глаголов")
		form$blocks[langId]=$block
		$block.classList.add('forms')
		if (langId==options.language) $block.classList.add('open')
		const handler=ev=>{
			options.forms[langId][ev.target.value]=ev.target.checked
			localStorage.setItem(`glaconjurer-form-${langId}-${ev.target.value}`,ev.target.checked?'1':'0')
			needToCreateFeature=true
		}
		for (const value of lang.listSelectableVerbForms()) createControl($block,
			`<label><input type=checkbox value=${value+(options.forms[langId][value]?' checked':'')}> ${lang.getVerbFormTitle(value)[0]}</label>`,
		handler)
	}

	const createFeature=()=>{
		while ($featureContainer.firstChild) $featureContainer.removeChild($featureContainer.firstChild)
		$featureContainer.className=''
		if (feature=='conjgame') {
			createConjugationGame($featureContainer,options.forms[options.language])
		} else {
			createConjugationTable($featureContainer,options.language,options.sort,options.forms[options.language],options.order,options.table)
		}
	}
	createFeature()

	const $openerContainer=document.createElement('div')
	$openerContainer.classList.add('opener')
	$optionsContainer.appendChild($openerContainer)
	const $dialog=document.createElement('div')
	$dialog.classList.add('dialog')
	$optionsContainer.appendChild($dialog)
	const $closerContainer=document.createElement('div')
	$closerContainer.classList.add('closer')
	const $openerButton=document.createElement('button')
	$openerButton.innerHTML='⚙️' //'Настройки'
	$openerContainer.appendChild($openerButton)
	$openerButton.addEventListener('click',()=>{
		$dialog.classList.add('open')
	})
	const $closerButton=document.createElement('button')
	$closerButton.innerHTML='←' //'Назад'
	$closerContainer.appendChild($closerButton)
	$closerButton.addEventListener('click',()=>{
		if (needToCreateFeature) {
			needToCreateFeature=false
			createFeature()
		}
		$dialog.classList.remove('open')
	})
	$dialog.appendChild($closerContainer)
	$dialog.appendChild($languageBlock)
	$dialog.appendChild($featureBlock)
	$dialog.appendChild($tableBlock)
	$dialog.appendChild($sortBlock)
	for (const $block of Object.values(form$blocks)) {
		$dialog.appendChild($block)
	}
	$dialog.appendChild($orderBlock)
}

const $body=document.getElementsByTagName('body')[0]
const $featureContainer=document.createElement('div')
$featureContainer.id='feature'
$body.appendChild($featureContainer)
const $optionsContainer=document.createElement('div')
$optionsContainer.id='options'
$body.appendChild($optionsContainer)
createOptions($featureContainer,$optionsContainer)

</script>
</body>
</html>
